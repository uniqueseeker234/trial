<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Algae Identifier ğŸŒ¿</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">

  <style>
    body { 
      background: linear-gradient(to bottom, #E8F5E9, #C8E6C9);
      font-family: 'Montserrat', sans-serif;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      margin-bottom: 20px;
      transition: transform 0.3s, opacity 0.5s;
      opacity: 0;
    }
    .card.show { opacity: 1; }
    .card:hover { transform: translateY(-5px); }
    button.btn-success { 
      background-color: #2E7D32; 
      border: none; 
      transition: background 0.3s;
    }
    button.btn-success:hover { background-color: #1B5E20; }
    img.example { 
      border-radius: 10px; 
      width: 100%; 
      height: auto;
    }
    #stars span { cursor: pointer; font-size: 26px; margin: 0 3px; transition: transform 0.2s; }
    #stars span:hover { transform: scale(1.3); }
    #message { font-weight: 500; }
    #spinner { animation: spin 1s linear infinite; display: inline-block; margin-left:5px; }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
  </style>
</head>
<body>

<div class="container mt-5 text-center">
  <h1 class="mb-4">Algae Identifier ğŸŒ¿</h1>

  <!-- Upload Card -->
  <div class="card p-4 show">
    <input type="file" class="form-control" id="imageUpload" accept="image/*">
    <div id="message" class="text-success mt-2">
      <span id="scanText">Upload your algae photo to start!</span>
      <span id="spinner" class="d-none">ğŸŒ€</span>
    </div>
  </div>

  <!-- Prediction Card -->
  <div id="result" class="card p-3">
    <h3 id="predictedName"></h3>
    <p id="confidence"></p>
    <p id="description"></p>

    <!-- Carousel for example images -->
    <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner" id="carouselInner"></div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  </div>

  <!-- Star Rating -->
  <div id="stars" class="my-3">
    <span onclick="rate(1)">â­</span>
    <span onclick="rate(2)">â­</span>
    <span onclick="rate(3)">â­</span>
    <span onclick="rate(4)">â­</span>
    <span onclick="rate(5)">â­</span>
  </div>

  <!-- Contribute and Gallery Buttons -->
  <button class="btn btn-success mb-2" onclick="contribute()">
    Contribute ğŸ“¨
  </button>
  <a href="gallery.html" class="btn btn-outline-success">Explore Algae Around the World ğŸŒ</a>
</div>

<!-- TensorFlow & Teachable Machine JS -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
// âœ… Model folder
const MODEL_URL = "my_model/"; 

let model, maxPredictions;

// 4-algae info
const algaeInfo = {
  "Cladophora": {
    description: `â€¢ Filamentous green algae forming dense mats.
â€¢ Branching filaments with coarse texture.
â€¢ Commonly grows in clean freshwater.
Economic importance:
â€¢ Used in wastewater treatment.
â€¢ Source of bioactive compounds.
Location: Freshwater ponds and rivers, Kerala.`,
    images: ["images/cladophora1.jpg","images/cladophora2.jpg"]
  },
  "Oedogonium": {
    description: `â€¢ Filamentous green algae with unbranched filaments.
â€¢ Grows attached to submerged plants or stones.
Economic importance:
â€¢ Fish feed in aquaculture.
â€¢ Produces oxygen improving water quality.
Location: Ponds, lakes, slow streams, Kerala.`,
    images: ["images/oedogonium1.jpg","images/oedogonium2.jpg"]
  },
  "Spirogyra": {
    description: `â€¢ Filamentous green algae with spiral chloroplasts.
â€¢ Forms floating green mats in freshwater.
Economic importance:
â€¢ Used in labs for study.
â€¢ Produces oxygen.
Location: Stagnant ponds and ditches, Kerala.`,
    images: ["images/spirogyra1.jpg","images/spirogyra2.jpg"]
  },
  "Cosmarium": {
    description: `â€¢ Green desmid with symmetrical cells and constriction in the middle.
Economic importance:
â€¢ Bioindicator for ecology.
â€¢ Source of pigments.
Location: Freshwater ponds and marshes, Kerala.`,
    images: ["images/cosmarium1.jpg","images/cosmarium2.jpg"]
  }
};

// Load Teachable Machine model
async function init() {
  try {
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    maxPredictions = model.getTotalClasses();
    console.log("Model loaded successfully!");
  } catch (err) {
    console.error("Error loading model:", err);
    document.getElementById("message").innerText = "Failed to load model. Check console.";
  }
}

// Star rating
function rate(star){
  alert("Thanks for giving " + star + " stars!");
  localStorage.setItem("rating", star);
}

// Detect mobile
function isMobileDevice() {
  return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// Contribute function (mobile mailto, desktop popup)
function contribute() {
  if(isMobileDevice()){
    window.location.href = 'mailto:uniqueseekers123@gmail.com?subject=Algae Contribution';
  } else {
    alert("Please email your algae photos to: uniqueseekers123@gmail.com");
  }
}

// Handle Image Upload
document.getElementById("imageUpload").addEventListener("change", async function(){
  const file = this.files[0];
  if(!file) return;

  const confidenceThreshold = 0.6; // 60%

  // Show scanning animation
  document.getElementById("spinner").classList.remove("d-none");
  let dots = 0;
  const msgInterval = setInterval(()=>{
    dots = (dots + 1) % 4;
    document.getElementById("scanText").innerText = "Scanning the pond for your algae ğŸŒ¿" + ".".repeat(dots);
  }, 500);

  document.getElementById("result").classList.remove("show");
  document.getElementById("result").classList.add("d-none");

  const img = new Image();
  img.src = URL.createObjectURL(file); 
  img.onload = async () => {
    try {
      const prediction = await model.predict(img);
      const topPred = prediction.reduce((a,b)=>a.probability>b.probability?a:b);

      let algaeKey = null;
      if(topPred.probability >= confidenceThreshold){
        algaeKey = Object.keys(algaeInfo).find(
          key => topPred.className.toLowerCase().includes(key.toLowerCase())
        );
      }

      clearInterval(msgInterval);
      document.getElementById("spinner").classList.add("d-none");

      if(algaeKey){
        // âœ… High confidence + info available
        document.getElementById("predictedName").innerText = topPred.className;
        document.getElementById("confidence").innerText = "Confidence: " + (topPred.probability*100).toFixed(2) + "%";
        document.getElementById("description").innerText = algaeInfo[algaeKey].description;

        // Carousel
        const carouselInner = document.getElementById("carouselInner");
        carouselInner.innerHTML = "";
        algaeInfo[algaeKey].images.forEach((src, i) => {
          carouselInner.innerHTML += `<div class="carousel-item ${i===0?'active':''}">
            <img src="${src}" class="d-block w-100 example">
          </div>`;
        });

      } else {
        // âœ… Low confidence or unknown algae
        document.getElementById("predictedName").innerText = topPred.className;
        document.getElementById("confidence").innerText = "Confidence: " + (topPred.probability*100).toFixed(2) + "%";
        document.getElementById("description").innerText = "This algae is not yet recognized in our pond ğŸŒ±. If you know it, please contribute photos to help us expand our dataset!";
        document.getElementById("carouselInner").innerHTML = "";
      }

      // Show result card with fade-in
      const resultCard = document.getElementById("result");
      resultCard.classList.remove("d-none");
      setTimeout(()=>{resultCard.classList.add("show");}, 50);

      document.getElementById("scanText").innerText = "Prediction complete! ğŸŒ¿";

    } catch(err){
      clearInterval(msgInterval);
      document.getElementById("spinner").classList.add("d-none");
      console.error("Prediction error:", err);
      document.getElementById("scanText").innerText = "Failed to predict. Check console.";
    }
  }
});

init();
</script>

</body>
</html>
