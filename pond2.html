<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pond 2 ‚Ä¢ UniqueSeeker‚Äôs Algae Pond</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>

<style>
  :root{
    /* ‚úÖ LOCKED Pond 2 water palette */
    --waterA:#5FC2A7;   /* surface */
    --waterB:#3CC19E;   /* mid */
    --waterC:#148B86;   /* deep */

    --glass: rgba(255,255,255,0.14);
    --border: rgba(255,255,255,0.22);
    --text: rgba(255,255,255,0.95);
    --shadow: 0 18px 45px rgba(0,0,0,0.28);
  }

  html,body{
    margin:0;height:100%;
    font-family:Poppins,system-ui,Arial;
    overflow-x:hidden;
    background:#051b1a;
    color:var(--text);
  }

  /* ================= BACKGROUND ================= */
  .pond-bg{
    position:fixed; inset:0;
    z-index:0;
    background: linear-gradient(to bottom,
      var(--waterA) 0%,
      var(--waterB) 48%,
      var(--waterC) 100%);
    overflow:hidden;
  }

  /* shimmer (lightweight) */
  .pond-bg::before{
    content:"";
    position:absolute; inset:-20%;
    background:
      radial-gradient(900px 420px at 50% 18%, rgba(255,255,255,0.20), transparent 62%),
      radial-gradient(700px 280px at 18% 30%, rgba(255,255,255,0.10), transparent 60%),
      radial-gradient(700px 280px at 82% 32%, rgba(255,255,255,0.09), transparent 60%),
      linear-gradient(to bottom, rgba(255,255,255,0.10), rgba(255,255,255,0.02) 35%, transparent 70%);
    opacity:0.85;
    animation: shimmer 8s ease-in-out infinite alternate;
    pointer-events:none;
  }
  @keyframes shimmer{
    from{ transform: translate3d(-1%, -0.4%, 0) scale(1.02); }
    to  { transform: translate3d( 1%,  0.4%, 0) scale(1.03); }
  }

  /* light rays */
  .pond-bg::after{
    content:"";
    position:absolute; inset:0;
    background:
      linear-gradient(110deg, transparent 0%, rgba(255,255,255,0.07) 30%, transparent 55%),
      linear-gradient(75deg,  transparent 0%, rgba(255,255,255,0.05) 35%, transparent 60%);
    mix-blend-mode: overlay;
    opacity:0.55;
    animation: rays 10s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes rays{
    0%,100%{ transform: translateY(-10px) translateX(-10px); opacity:0.40; }
    50%    { transform: translateY( 10px) translateX( 10px); opacity:0.65; }
  }

  /* ‚úÖ soft surface split (NO hard line) */
  .surface{
    position:absolute; left:0; right:0;
    top: 16vh;
    height: 16vh;
    pointer-events:none;
    z-index:1;
  }
  .surface::before{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to bottom,
      rgba(255,255,255,0.20),
      rgba(255,255,255,0.08),
      rgba(255,255,255,0.02),
      transparent 70%);
    opacity:0.85;
  }
  .surface::after{
    content:"";
    position:absolute; left:-10%; right:-10%;
    top: 18%;
    height: 55%;
    background:
      radial-gradient(180px 22px at 10% 55%, rgba(255,255,255,0.16), transparent 72%),
      radial-gradient(220px 26px at 35% 40%, rgba(255,255,255,0.12), transparent 74%),
      radial-gradient(210px 24px at 60% 65%, rgba(255,255,255,0.11), transparent 74%),
      radial-gradient(220px 26px at 85% 45%, rgba(255,255,255,0.10), transparent 74%);
    opacity:0.75;
    animation: surfaceMove 6.5s ease-in-out infinite alternate;
  }
  @keyframes surfaceMove{ from{ transform: translateX(-1.3%);} to{ transform: translateX(1.3%);} }

  /* ================= TOP BAR ================= */
  .topbar{
    position:fixed; left:14px; right:14px; top:12px;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
    z-index:60;
    pointer-events:none;
  }
  .pill{
    pointer-events:auto;
    background: rgba(0,0,0,0.22);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 999px;
    padding: 10px 14px;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.20);
    display:flex; align-items:center; gap:10px;
    font-weight:700;
  }
  .right-pills{ display:flex; gap:10px; }
  .pill a, .pill button{
    all:unset;
    cursor:pointer;
    color:var(--text);
    font-weight:800;
  }

  /* ================= INTRO TEXT ================= */
  .intro{
    position:fixed; inset:0;
    z-index:55;
    display:flex; justify-content:center;
    padding-top: 62px;
    pointer-events:none;
  }
  .intro .stack{
    text-align:center;
    opacity:0;
    transform: translateY(8px);
    animation: introShow 5.0s ease forwards;
  }
  .intro h1{
    margin:0;
    font-size: clamp(20px, 3.4vw, 40px);
    text-shadow: 0 10px 25px rgba(0,0,0,0.25);
  }
  .intro p{
    margin:10px 0 0;
    font-size: clamp(13px, 2.0vw, 18px);
    opacity:0.92;
    text-shadow: 0 10px 25px rgba(0,0,0,0.20);
  }
  @keyframes introShow{
    0%   { opacity:0; transform: translateY(12px); }
    20%  { opacity:1; transform: translateY(0); }
    78%  { opacity:1; }
    100% { opacity:0; transform: translateY(-6px); }
  }

  /* ================= SURFACE OBJECTS ================= */
  .surface-layer{
    position:fixed;
    left:0; right:0;
    top: 8vh;
    height: 26vh;
    z-index:40;       /* above fish + above UI */
    pointer-events:none;
  }

  /* ‚úÖ Lotus leaf pad (not skateboard) */
  .pad{
    position:absolute;
    width: 210px;
    height: 110px;
    border-radius: 999px;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.22), transparent 55%),
      radial-gradient(circle at 55% 50%, rgba(0,0,0,0.10), transparent 62%),
      linear-gradient(to bottom, rgba(86,230,170,0.98), rgba(18,122,92,0.98));
    border: 1px solid rgba(255,255,255,0.22);
    box-shadow: 0 22px 55px rgba(0,0,0,0.22);
    filter: saturate(1.05);
    animation: padBob 4.8s ease-in-out infinite;
  }
  /* notch cut */
  .pad::after{
    content:"";
    position:absolute;
    right: 20px;
    top: 48px;
    width: 60px;
    height: 48px;
    border-radius: 999px;
    background: rgba(0,0,0,0);
    box-shadow: inset -32px 0 0 rgba(0,0,0,0.14);
    transform: rotate(14deg);
    opacity:0.75;
  }
  @keyframes padBob{
    0%,100%{ transform: translateY(0) rotate(-0.6deg); }
    50%    { transform: translateY(5px) rotate(0.6deg); }
  }

  /* ‚úÖ Frog (eyes INSIDE head) */
  .frog{
    position:absolute;
    left: 56px;
    top: 34px;
    width: 86px;
    height: 52px;
    border-radius: 999px;
    background: linear-gradient(to bottom, #bff7ce, #22c55e);
    border: 1px solid rgba(255,255,255,0.22);
    box-shadow: 0 16px 28px rgba(0,0,0,0.18);
    overflow:hidden;
  }
  .frog .eye{
    position:absolute;
    top: 10px;
    width: 18px;
    height: 18px;
    border-radius:50%;
    background: #eafff2;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,0.10);
  }
  .frog .eye.left{ left: 14px; }
  .frog .eye.right{ right: 14px; }
  .frog .pupil{
    position:absolute;
    top: 6px;
    left: 6px;
    width: 7px; height: 7px;
    border-radius:50%;
    background: rgba(0,0,0,0.55);
  }

  /* more frequent head turn */
  .frog-turn{ animation: frogTurn 2.2s ease-in-out infinite; transform-origin:center; }
  @keyframes frogTurn{
    0%,100%{ transform: rotate(0deg); }
    35%    { transform: rotate(4deg); }
    60%    { transform: rotate(-4deg); }
  }

  /* ‚úÖ Lotus flower (simple anime) */
  .lotus{
    position:absolute;
    right: 26px;
    top: 18px;
    width: 82px; height: 70px;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,0.18));
    animation: lotusSway 4.2s ease-in-out infinite;
  }
  @keyframes lotusSway{
    0%,100%{ transform: rotate(-1deg) translateY(0); }
    50%{ transform: rotate(1deg) translateY(2px); }
  }
  .lotus .petal{
    position:absolute;
    left: 50%; top: 52%;
    width: 28px; height: 42px;
    background: radial-gradient(circle at 30% 30%, rgba(255,240,248,0.96), rgba(255,140,185,0.92));
    border-radius: 999px;
    transform-origin: bottom center;
    border: 1px solid rgba(255,255,255,0.18);
  }
  .lotus .petal:nth-child(1){ transform: translate(-50%,-60%) rotate(0deg); }
  .lotus .petal:nth-child(2){ transform: translate(-50%,-60%) rotate(45deg); }
  .lotus .petal:nth-child(3){ transform: translate(-50%,-60%) rotate(90deg); }
  .lotus .petal:nth-child(4){ transform: translate(-50%,-60%) rotate(135deg); }
  .lotus .petal:nth-child(5){ transform: translate(-50%,-60%) rotate(180deg); }
  .lotus .petal:nth-child(6){ transform: translate(-50%,-60%) rotate(225deg); }
  .lotus .petal:nth-child(7){ transform: translate(-50%,-60%) rotate(270deg); }
  .lotus .petal:nth-child(8){ transform: translate(-50%,-60%) rotate(315deg); }
  .lotus .center{
    position:absolute;
    left:50%; top:52%;
    width: 16px; height: 16px;
    background: radial-gradient(circle at 30% 30%, #fff5a5, #ffcc4a);
    border-radius:50%;
    transform: translate(-50%,-30%);
    border: 1px solid rgba(255,255,255,0.18);
  }

  /* ================= UI ================= */
  .ui-wrap{
    position:relative;
    z-index:30; /* below surface layer */
    padding: 255px 14px 40px; /* space for surface objects */
    display:flex;
    justify-content:center;
  }
  .panel{
    width:min(980px, 100%);
    display:grid;
    grid-template-columns: 1.15fr 0.85fr;
    gap:16px;
    align-items:start;
  }
  .card{
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 16px;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
  }
  .upload-box{
    background: rgba(255,255,255,0.16);
    border: 1px solid rgba(255,255,255,0.18);
    padding: 16px;
    border-radius: 14px;
    cursor:pointer;
    transition: transform 0.15s ease, background 0.2s ease;
    font-weight:800;
  }
  .upload-box:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.20); }

  #prediction{ margin:12px 0 6px; font-size: 15px; }
  .description{ font-size: 13px; line-height: 1.55; opacity:0.96; }
  .description h3{ margin: 10px 0 6px; font-size: 13px; }
  .description ul{ margin: 0 0 0 18px; padding:0; }

  .carousel{ margin-top:10px; position:relative; width:100%; max-width:220px; }
  .carousel img{ width:100%; border-radius:14px; display:none; border:1px solid rgba(255,255,255,0.20); }
  .carousel img.active{ display:block; }
  .carousel button{
    position:absolute; top:50%; transform:translateY(-50%);
    background: rgba(0,0,0,0.22);
    border:1px solid rgba(255,255,255,0.16);
    color:white;
    font-size:18px;
    padding:6px 10px;
    cursor:pointer;
    border-radius:10px;
  }
  .prev{ left:6px; } .next{ right:6px; }

  .stars span{
    font-size:28px; cursor:pointer; color:rgba(255,255,255,0.40);
    display:inline-block; transition: transform 0.2s ease, color 0.2s ease;
  }
  .stars span.filled{ color: #ffd35a; transform: scale(1.08); }
  .thank-message{ margin-top:10px; min-height:24px; font-size: 13px; opacity:0.95; }

  .btn{
    width:100%;
    margin-top:10px;
    padding: 11px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.18);
    cursor:pointer;
    font-weight:900;
    background: rgba(0,0,0,0.20);
    color: var(--text);
    backdrop-filter: blur(8px);
    transition: transform 0.15s ease, background 0.2s ease;
  }
  .btn:hover{ transform: translateY(-1px); background: rgba(0,0,0,0.26); }
  .btn.primary{ background: rgba(39,174,96,0.44); }
  .btn.primary:hover{ background: rgba(39,174,96,0.54); }
  .btn.blue{ background: rgba(41,128,185,0.42); }
  .btn.blue:hover{ background: rgba(41,128,185,0.52); }

  @media (max-width: 860px){
    .panel{ grid-template-columns: 1fr; }
    .ui-wrap{ padding-top: 240px; }
    .pad{ width: 190px; height: 100px; }
  }

  /* ================= SEAWEED (SIDES) ================= */
  .seaweed{
    position:fixed;
    bottom:-14px;
    width: 22px;
    height: 240px;
    border-radius: 18px 18px 10px 10px;
    background: linear-gradient(to top, rgba(6,92,73,0.95), rgba(35,170,125,0.80));
    opacity:0.86;
    z-index:10;     /* behind fish */
    transform-origin: bottom center;
    animation: weedSway 3.8s ease-in-out infinite alternate;
    pointer-events:none;
  }
  @keyframes weedSway{ from{ transform: rotate(-4deg);} to{ transform: rotate(4deg);} }

  /* ================= FISH (4 ALWAYS, UNDERWATER ONLY) ================= */
  .fish{
    position:fixed;
    width:62px; height:30px;
    z-index:20;         /* visible but below UI */
    pointer-events:none;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,0.18));
    will-change: transform;
  }
  .fish .body{
    position:absolute; inset:0;
    border-radius: 999px;
    background: var(--c);
    box-shadow: inset 0 3px 0 rgba(255,255,255,0.20);
  }
  .fish .tail{
    position:absolute; top:7px;
    width:18px; height:16px;
    background: var(--c);
    border-radius: 4px;
    clip-path: polygon(0 50%, 100% 0, 100% 100%);
    opacity:0.95;
  }
  .fish .finTop{
    position:absolute;
    width:16px; height:12px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.16);
    border-radius: 14px 14px 6px 6px;
    top: -3px;
    left: 22px;
    transform: rotate(-10deg);
  }
  .fish .finSide{
    position:absolute;
    width:14px; height:10px;
    background: rgba(255,255,255,0.14);
    border: 1px solid rgba(255,255,255,0.16);
    border-radius: 10px 10px 10px 0;
    top: 10px;
    left: 24px;
    transform: rotate(-8deg);
  }
  .fish .eye{
    position:absolute; top:11px;
    width:7px; height:7px; border-radius:50%;
    background: rgba(0,0,0,0.55);
    box-shadow: 0 0 0 2px rgba(255,255,255,0.26);
  }

  .fish.right .tail{ left:-10px; }
  .fish.right .eye{ right:12px; }

  /* ‚úÖ fish swim animations (CSS only -> less lag) */
  @keyframes swimRight{
    from{ transform: translate3d(-120px, var(--y), 0); }
    to  { transform: translate3d(calc(100vw + 120px), var(--y), 0); }
  }
  @keyframes swimLeft{
    from{ transform: translate3d(calc(100vw + 120px), var(--y), 0) scaleX(-1); }
    to  { transform: translate3d(-120px, var(--y), 0) scaleX(-1); }
  }

  /* ================= BUBBLES (LOW LAG) ================= */
  .bubble{
    position:fixed;
    width: 10px; height: 10px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.90), rgba(255,255,255,0.10));
    box-shadow: 0 0 12px rgba(255,255,255,0.22);
    z-index:18;
    pointer-events:auto;
    opacity:0.80;
    animation: rise var(--dur) linear infinite;
    will-change: transform;
  }
  @keyframes rise{
    from{ transform: translate3d(0, 0, 0); }
    to  { transform: translate3d(var(--drift), -120vh, 0); }
  }
  .bubble.pop{ animation: pop 0.25s ease forwards !important; }
  @keyframes pop{ to{ transform: scale(2.0); opacity:0; } }

</style>
</head>

<body>
  <div class="pond-bg">
    <div class="surface"></div>
  </div>

  <div class="topbar">
    <div class="pill">üåø UniqueSeeker‚Äôs Algae Pond ‚Ä¢ Pond 2</div>
    <div class="right-pills">
      <div class="pill"><a href="./index.html">Pond 1</a></div>
      <div class="pill"><button id="pond2Btn">Pond 2</button></div>
    </div>
  </div>

  <div class="intro">
    <div class="stack">
      <h1>Welcome to Uniqueseeker‚Äôs Algal Pond</h1>
      <p>See if your algae is already here. Or help the journal grow.</p>
    </div>
  </div>

  <!-- Surface layer -->
  <div class="surface-layer" id="surfaceLayer"></div>

  <!-- UI -->
  <div class="ui-wrap">
    <div class="panel">
      <div class="card">
        <div class="upload-box" id="uploadBox">üåø Select your algae photo to start!</div>
        <input type="file" id="imageUpload" accept="image/*" style="display:none;">
        <div id="prediction"></div>
        <div class="carousel" id="carousel"></div>
        <div id="description" class="description"></div>
      </div>

      <div class="card" style="text-align:center;">
        <div class="stars" id="stars"></div>
        <div class="thank-message" id="thankMessage"></div>
        <button class="btn primary contribute">Contribute üì®</button>
        <button class="btn blue explore">Explore Algae Around the World üåè</button>
      </div>
    </div>
  </div>

<script>
/* ===================== MODEL ===================== */
let model;
let classes = [];
const CONFIDENCE_THRESHOLD = 0.65;

// ‚úÖ unchanged folder names (images + my_model)
const algaeInfo = {
  "spirogyra": {images:["images/spirogyra1.jpg","images/spirogyra2.jpg"], habit:["Filamentous freshwater green algae","Forms floating slimy masses","Has spiral chloroplasts"], economic:["Produces oxygen in ponds","Used in biological research"], location:["Found in freshwater ponds","Common in slow-moving water bodies"]},
  "cladophora": {images:["images/cladophora1.jpg","images/cladophora2.jpg","images/cladophora3.jpg"], habit:["Branched filamentous green algae","Attaches to submerged surfaces","Forms dense green mats"], economic:["Provides shelter for aquatic organisms","Indicates nutrient pollution levels"], location:["Freshwater & marine habitats","Common in nutrient-rich environments"]},
  "oedogonium": {images:["images/oedogonium1.jpg","images/oedogonium2.jpg"], habit:["Filamentous green algae with basal holdfast","Grows in mats or attached filaments","Prefers calm water"], economic:["Used in research and water quality monitoring","Oxygen producer in water bodies"], location:["Freshwater ponds and slow streams","Common in nutrient-rich ponds"]},
  "volvox": {images:["images/volvox1.jpg","images/volvox2.jpg"], habit:["Spherical colonial green algae","Colonies with flagella","Forms motile spheres"], economic:["Used in biological experiments","Oxygen producer"], location:["Freshwater ponds and lakes","Common in nutrient-rich water"]},
  "nostoc": {images:["images/nostoc1.jpg","images/nostoc2.jpg"], habit:["Cyanobacteria forming colonies","Gelatinous colonies","Filamentous structure"], economic:["Nitrogen fixation","Used in research"], location:["Freshwater and moist soils","Found on rocks and soil surfaces"]},
  "pediastrum": {images:["images/pediastrum1.jpg","images/pediastrum2.jpg"], habit:["Colonial green algae","Flat star-like colonies","Planktonic in water"], economic:["Used in ecological studies","Indicator of water quality"], location:["Freshwater ponds","Common in nutrient-rich water"]},
  "cosmarium": {images:["images/cosmarium1.jpg","images/cosmarium2.jpg"], habit:["Single-celled green algae with semicells","Desmids are symmetrical","Often found in colonies"], economic:["Used in ecological studies","Indicator of water quality"], location:["Freshwater habitats","Ponds and lakes with clean water"]},
  "noctiluca": {images:["images/noctiluca1.jpg","images/noctiluca2.jpg"], habit:["Bioluminescent marine plankton","Single-celled","Motile with flagella"], economic:["Indicators of marine water health","Can cause red tides"], location:["Marine environments","Coastal waters worldwide"]},
  "staurastrum": {images:["images/staurastrum1.jpg","images/staurastrum2.jpg"], habit:["Single-celled desmid","Star-shaped cells","Free-floating"], economic:["Used in water quality studies","Indicator species"], location:["Freshwater ponds","Clean, slow-moving waters"]},
  "scenedesmus": {images:["images/scenedesmus1.jpg","images/scenedesmus2.jpg"], habit:["Colonial green algae","Forms four-cell colonies","Common planktonic algae"], economic:["Used in biofuel research","Indicator of water quality"], location:["Freshwater ponds","Often in nutrient-rich waters"]}
};

async function loadModel(){
  model = await tf.loadLayersModel("my_model/model.json");
  const metadata = await fetch("my_model/metadata.json").then(r=>r.json());
  classes = metadata.labels.map(l => l.trim().toLowerCase());
}
loadModel();

/* ===================== UI ===================== */
const uploadBox = document.getElementById("uploadBox");
const imageUpload = document.getElementById("imageUpload");
uploadBox.addEventListener("click", ()=> imageUpload.click());

/* Stars */
const starsContainer = document.getElementById("stars");
const thankMessage = document.getElementById("thankMessage");
let rating = 0;

function renderStars(){
  starsContainer.innerHTML="";
  for(let i=1;i<=5;i++){
    const star=document.createElement("span");
    star.innerHTML = (i<=rating) ? "‚òÖ" : "‚òÜ";
    if(i<=rating) star.classList.add("filled");
    star.onclick=()=> rateStar(i);
    star.addEventListener("touchstart",()=> rateStar(i), {passive:true});
    starsContainer.appendChild(star);
  }
}
function rateStar(i){
  rating=i; renderStars();
  const messages={1:"üò¢ We'll improve! Thanks!",2:"üôÇ Thank you! We‚Äôll grow!",3:"üòä Nice! Thanks!",4:"üåü Awesome! You‚Äôre amazing!",5:"üòç WOW! You love our pond!"};
  thankMessage.innerText=messages[i];
}
renderStars();

/* Carousel */
function createCarousel(images){
  const carouselDiv=document.getElementById("carousel");
  carouselDiv.innerHTML="";
  if(!images || images.length===0) return;

  images.forEach((src,i)=>{
    const img=document.createElement("img");
    img.src=src;
    if(i===0) img.classList.add("active");
    carouselDiv.appendChild(img);
  });

  const prevBtn=document.createElement("button");
  prevBtn.className="prev"; prevBtn.innerHTML="&#10094;"; prevBtn.onclick=()=> moveSlide(-1);
  const nextBtn=document.createElement("button");
  nextBtn.className="next"; nextBtn.innerHTML="&#10095;"; nextBtn.onclick=()=> moveSlide(1);
  carouselDiv.appendChild(prevBtn);
  carouselDiv.appendChild(nextBtn);
  carouselDiv.currentIndex=0;
}
function moveSlide(dir){
  const carouselDiv=document.getElementById("carousel");
  const imgs=carouselDiv.querySelectorAll("img");
  if(!imgs.length) return;
  imgs[carouselDiv.currentIndex].classList.remove("active");
  carouselDiv.currentIndex=(carouselDiv.currentIndex+dir+imgs.length)%imgs.length;
  imgs[carouselDiv.currentIndex].classList.add("active");
}

/* Prediction */
imageUpload.addEventListener("change", async (event)=>{
  const file = event.target.files[0];
  if(!file) return;

  const img = new Image();
  img.src = URL.createObjectURL(file);

  img.onload = async ()=>{
    const tensor = tf.browser.fromPixels(img).resizeNearestNeighbor([224,224]).toFloat().div(255.0).expandDims();
    const prediction = model.predict(tensor);
    const data = await prediction.data();

    const maxValue = Math.max(...data);
    const index = data.indexOf(maxValue);
    const predictedClass = classes[index];
    const confidence = (maxValue*100).toFixed(2);

    const predictionText=document.getElementById("prediction");
    const descriptionBox=document.getElementById("description");
    const info = algaeInfo[predictedClass] || algaeInfo[(predictedClass||"").toLowerCase()];

    if((predictedClass||"").toLowerCase() === "unknown algae"){
      predictionText.innerHTML = "Prediction: <b>Unknown Algae</b>";
      descriptionBox.innerHTML = "<h3>üêüüåø Not yet in the pond!</h3><p>If you know it, please contribute a photo üå±üíö</p>";
      createCarousel([]);
      tensor.dispose(); prediction.dispose();
      return;
    }

    if(maxValue >= CONFIDENCE_THRESHOLD && info){
      predictionText.innerHTML = `Prediction: <b>${predictedClass.charAt(0).toUpperCase()+predictedClass.slice(1)}</b><br>Confidence: ${confidence}%`;
      createCarousel(info.images);
      descriptionBox.innerHTML =
        "<h3>Habit</h3><ul>"+info.habit.map(x=>"<li>"+x+"</li>").join("")+"</ul>"+
        "<h3>Economic Importance</h3><ul>"+info.economic.map(x=>"<li>"+x+"</li>").join("")+"</ul>"+
        "<h3>Location</h3><ul>"+info.location.map(x=>"<li>"+x+"</li>").join("")+"</ul>";
    } else {
      predictionText.innerHTML = `Confidence: ${confidence}%`;
      createCarousel([]);
      descriptionBox.innerHTML="<h3>üêüüåø Not yet in the pond!</h3><p>Hmm‚Ä¶ this algae is not yet in our pond. If you know it, please contribute üå±üíö</p>";
    }

    tensor.dispose();
    prediction.dispose();
  };
});

/* Buttons */
document.querySelector(".contribute").addEventListener("click",()=>{
  const email="uniqueseeekers123@gmail.com";
  const subject=encodeURIComponent("Algae Contribution üåø");
  const body=encodeURIComponent("Hello! I want to contribute an algae image or info to your pond project.");
  if(window.innerWidth>768){
    alert(`üíö Thanks for contributing!\nSend images/info to: ${email}`);
  }else{
    window.location.href=`mailto:${email}?subject=${subject}&body=${body}`;
  }
});
document.querySelector(".explore").addEventListener("click",()=>{
  alert("üåé Global algae exploration coming soon!");
});

/* ===================== POND VISUALS ===================== */
const surfaceLayer = document.getElementById("surfaceLayer");

function buildSurface(){
  surfaceLayer.innerHTML = "";

  // Pad 1 with frog
  const pad1 = document.createElement("div");
  pad1.className = "pad";
  pad1.style.left = "6%";
  pad1.style.top  = "7vh";

  const frog = document.createElement("div");
  frog.className = "frog frog-turn";
  frog.innerHTML = `
    <div class="eye left"><div class="pupil"></div></div>
    <div class="eye right"><div class="pupil"></div></div>
  `;
  pad1.appendChild(frog);
  surfaceLayer.appendChild(pad1);

  // Pad 2 with lotus flower
  const pad2 = document.createElement("div");
  pad2.className = "pad";
  pad2.style.left = "58%";
  pad2.style.top  = "8vh";
  pad2.style.opacity = "0.96";

  const lotus = document.createElement("div");
  lotus.className = "lotus";
  lotus.innerHTML = `
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
    <div class="center"></div>
  `;
  pad2.appendChild(lotus);
  surfaceLayer.appendChild(pad2);
}
buildSurface();

/* Seaweed sides */
function buildSeaweed(){
  document.querySelectorAll(".seaweed").forEach(n=>n.remove());
  const positions = [
    {x:"2%",  h:240, d:"0s"},
    {x:"6%",  h:290, d:"0.7s"},
    {x:"10%", h:260, d:"1.2s"},
    {x:"90%", h:270, d:"0.5s"},
    {x:"94%", h:310, d:"1.0s"},
    {x:"98%", h:250, d:"1.5s"}
  ];
  positions.forEach(p=>{
    const w=document.createElement("div");
    w.className="seaweed";
    w.style.left=p.x;
    w.style.height=p.h+"px";
    w.style.animationDelay=p.d;
    document.body.appendChild(w);
  });
}
buildSeaweed();

/* Fish (4 always visible) */
function makeFish(color, dir, yPx, dur, delay){
  const f = document.createElement("div");
  f.className = "fish " + dir;
  f.style.setProperty("--c", color);
  f.style.setProperty("--y", yPx + "px");

  f.innerHTML = `
    <div class="body"></div>
    <div class="tail"></div>
    <div class="finTop"></div>
    <div class="finSide"></div>
    <div class="eye"></div>
  `;

  // animation
  if(dir === "right"){
    f.style.animation = `swimRight ${dur}s linear infinite`;
  }else{
    f.style.animation = `swimLeft ${dur}s linear infinite`;
  }
  f.style.animationDelay = delay + "s";

  document.body.appendChild(f);
  return f;
}

function placeFish(){
  // remove old fish
  document.querySelectorAll(".fish").forEach(n=>n.remove());

  const vh = window.innerHeight;
  // underwater only (below surface + below UI top area)
  const y1 = Math.round(vh * 0.62);
  const y2 = Math.round(vh * 0.72);
  const y3 = Math.round(vh * 0.80);
  const y4 = Math.round(vh * 0.88);

  makeFish("#ffb74a","right",y1, 13, -2);
  makeFish("#ff6b6b","left", y2, 14, -6);
  makeFish("#ffd966","right",y3, 15, -9);
  makeFish("#7dd3fc","left", y4, 16, -4);
}
placeFish();

/* Bubbles (reduced + CSS only) */
const MAX_BUBBLES = 6;
function spawnBubble(){
  const b=document.createElement("div");
  b.className="bubble";
  const size = 7 + Math.random()*9;
  b.style.width=size+"px";
  b.style.height=size+"px";
  b.style.left=(Math.random()*window.innerWidth)+"px";
  // start underwater only
  b.style.top=(window.innerHeight*(0.55 + Math.random()*0.45))+"px";
  b.style.setProperty("--dur", (8 + Math.random()*6) + "s");
  b.style.setProperty("--drift", (Math.random()*60 - 30) + "px");

  b.addEventListener("click", ()=>{ b.classList.add("pop"); setTimeout(()=>b.remove(), 220); });
  b.addEventListener("touchstart", ()=>{ b.classList.add("pop"); setTimeout(()=>b.remove(), 220); }, {passive:true});

  document.body.appendChild(b);
}
function bubbleLoop(){
  const current=document.querySelectorAll(".bubble").length;
  if(current < MAX_BUBBLES){
    for(let i=0;i<MAX_BUBBLES-current;i++) spawnBubble();
  }
  setTimeout(bubbleLoop, 1400);
}
bubbleLoop();

/* rebuild on resize */
window.addEventListener("resize", ()=>{
  buildSeaweed();
  placeFish();
});
</script>
</body>
</html>
