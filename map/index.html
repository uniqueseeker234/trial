<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kerala 3D Algae Map</title>

<style>
:root{
  --bg:#0b1220;
  --accent:#4fb3ff;
}

body{
  margin:0;
  overflow:hidden;
  background:var(--bg);
  font-family:system-ui;
}

/* Top bar */
#topbar{
  position:fixed;
  top:15px;
  left:15px;
  z-index:1000;
  background:rgba(255,255,255,0.12);
  padding:10px 14px;
  border-radius:14px;
  color:white;
  backdrop-filter:blur(8px);
}

/* Popup */
#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  z-index:2000;
}

#popup{
  position:fixed;
  top:15px;
  right:15px;
  width:320px;
  max-height:75vh;
  overflow:auto;
  background:white;
  border-radius:16px;
  padding:14px;
  display:none;
  z-index:3000;
  border:3px solid var(--accent);
}

#popup.show,#overlay.show{
  display:block;
}

#popup h3{
  margin:0 0 10px;
  display:flex;
  align-items:center;
  gap:8px;
}

#dot{
  width:14px;
  height:14px;
  border-radius:50%;
  background:var(--accent);
}

#closeBtn{
  margin-top:10px;
  padding:8px 10px;
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:white;
  font-weight:bold;
  cursor:pointer;
}

@media(max-width:768px){
  #popup{
    left:10px;
    right:10px;
    bottom:10px;
    top:auto;
    width:auto;
  }
}
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>

<body>

<div id="topbar">Kerala 3D Algae Map</div>

<div id="overlay"></div>

<div id="popup">
  <h3><span id="dot"></span><span id="titleText"></span></h3>
  <div id="content"></div>
  <button id="closeBtn">Close</button>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { FontLoader } from "three/addons/loaders/FontLoader.js";
import { TextGeometry } from "three/addons/geometries/TextGeometry.js";

/* ------------------ DATA ------------------ */
const algaeData = {
  "Pathanamthitta":{
    algae:["Cosmarium","Staurastrum","Spirogyra","Nostoc","Scenedesmus"],
    places:["Temple ponds","Stream pools","Paddy canals"]
  }
};

/* ------------------ SCENE ------------------ */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b1220);

const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 5000);
camera.position.set(0,170,250);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.AmbientLight(0xffffff,0.8));

const raycaster = new THREE.Raycaster();
const pointer = new THREE.Vector2();
const clickable = [];

/* ------------------ POPUP ------------------ */
const overlay = document.getElementById("overlay");
const popup = document.getElementById("popup");
const titleText = document.getElementById("titleText");
const content = document.getElementById("content");

function openPopup(name,colorHex){
  document.documentElement.style.setProperty("--accent",colorHex);
  titleText.textContent = name;

  const data = algaeData[name] || {
    algae:["Spirogyra","Nostoc","Cladophora","Scenedesmus"],
    places:["Ponds","Canals","River edges"]
  };

  content.innerHTML =
    "<b>Common algae:</b><ul>" +
    data.algae.map(a=>"<li>"+a+"</li>").join("") +
    "</ul><br><b>Commonly seen in:</b><ul>" +
    data.places.map(p=>"<li>"+p+"</li>").join("") +
    "</ul>";

  overlay.classList.add("show");
  popup.classList.add("show");
}

document.getElementById("closeBtn").onclick = ()=>{
  overlay.classList.remove("show");
  popup.classList.remove("show");
};

overlay.onclick = ()=>{
  overlay.classList.remove("show");
  popup.classList.remove("show");
};

/* ------------------ HELPERS ------------------ */

function colorFromName(name){
  let hash=0;
  for(let i=0;i<name.length;i++)
    hash=name.charCodeAt(i)+((hash<<5)-hash);
  const hue=Math.abs(hash)%360;
  return new THREE.Color(`hsl(${hue},70%,55%)`);
}

function project(lon,lat){
  const scale=20;
  return new THREE.Vector2(lon*scale,lat*scale);
}

/* ------------------ LOAD GEOJSON ------------------ */
const geo = await fetch("./kerala_districts.geojson").then(r=>r.json());

const mapGroup = new THREE.Group();
scene.add(mapGroup);

for(const f of geo.features){

  const name = f.properties.shapeName;
  const color = colorFromName(name);
  const geom = f.geometry;

  const poly = geom.coordinates[0][0];
  const shapePts = poly.map(([lon,lat])=>project(lon,lat));
  const shape = new THREE.Shape(shapePts);

  const extrudeGeo = new THREE.ExtrudeGeometry(shape,{depth:10,bevelEnabled:false});
  const mat = new THREE.MeshStandardMaterial({color:color});
  const mesh = new THREE.Mesh(extrudeGeo,mat);

  mesh.rotation.x=-Math.PI/2;
  mesh.userData={name,colorHex:"#"+color.getHexString()};

  mapGroup.add(mesh);
  clickable.push(mesh);

  addTextOnDistrict(name,mesh);
}

/* ------------------ TEXT LABEL ------------------ */

function addTextOnDistrict(name,mesh){

  const loader = new FontLoader();

  loader.load(
    "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/fonts/helvetiker_regular.typeface.json",
    function(font){

      const textGeo = new TextGeometry(name,{
        font:font,
        size:2.8,
        height:0.4
      });

      textGeo.computeBoundingBox();

      const box = new THREE.Box3().setFromObject(mesh);
      const size = new THREE.Vector3();
      box.getSize(size);

      const textWidth = textGeo.boundingBox.max.x - textGeo.boundingBox.min.x;

      const scaleFactor = (size.x*0.6)/textWidth;
      textGeo.scale(scaleFactor,scaleFactor,scaleFactor);

      textGeo.computeBoundingBox();

      const textMat = new THREE.MeshBasicMaterial({color:0xffffff});
      const textMesh = new THREE.Mesh(textGeo,textMat);

      const centerOffset = new THREE.Vector3();
      textGeo.boundingBox.getCenter(centerOffset).multiplyScalar(-1);
      textMesh.position.copy(centerOffset);

      const center = new THREE.Vector3();
      box.getCenter(center);

      textMesh.position.x += center.x;
      textMesh.position.z += center.z;
      textMesh.position.y = 11;

      textMesh.rotation.x = -Math.PI/2;

      if(size.z > size.x*1.3){
        textMesh.rotation.z = Math.PI/2;
      }

      mapGroup.add(textMesh);
    }
  );
}

/* ------------------ CENTER MAP ------------------ */
const box=new THREE.Box3().setFromObject(mapGroup);
const center=new THREE.Vector3();
box.getCenter(center);
mapGroup.position.sub(center);

/* ------------------ CLICK ------------------ */
window.addEventListener("pointerdown",(e)=>{
  const rect=renderer.domElement.getBoundingClientRect();
  pointer.x=((e.clientX-rect.left)/rect.width)*2-1;
  pointer.y=-((e.clientY-rect.top)/rect.height)*2+1;

  raycaster.setFromCamera(pointer,camera);
  const hits=raycaster.intersectObjects(clickable);
  if(hits.length){
    const obj=hits[0].object;
    openPopup(obj.userData.name,obj.userData.colorHex);
  }
});

/* ------------------ LOOP ------------------ */
function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
