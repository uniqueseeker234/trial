<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PhotoHouse ‚Ä¢ Darkroom</title>

<style>
  :root{
    --bg0:#07131d;
    --bg1:#0a1a24;
    --wood1:#2a1b12;
    --wood2:#3a2518;
    --warm:#ffdbb3;
    --ink:rgba(255,255,255,0.92);
    --muted:rgba(255,255,255,0.70);
    --glass:rgba(255,255,255,0.10);
    --glass2:rgba(255,255,255,0.16);
    --border:rgba(255,255,255,0.18);
    --shadow:0 18px 55px rgba(0,0,0,0.55);
    --accent:#5FC2A7; /* pond teal */
    --accent2:#3CC19E;
    --danger:#ff7a7a;
    --ok:#7affc7;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:
      radial-gradient(1200px 800px at 15% 10%, rgba(255,219,179,0.08), transparent 55%),
      radial-gradient(900px 600px at 85% 18%, rgba(95,194,167,0.10), transparent 52%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow:hidden;
  }

  /* Room */
  .room{
    position:relative;
    height:100%;
    display:flex;
    flex-direction:column;
  }

  /* Top header */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 18px;
    gap:12px;
  }
  .brand{
    display:flex; gap:12px; align-items:center;
    min-width:260px;
  }
  .badge{
    width:44px; height:44px; border-radius:14px;
    background:linear-gradient(135deg, rgba(255,219,179,0.18), rgba(95,194,167,0.16));
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    display:grid; place-items:center;
    position:relative;
    overflow:hidden;
    flex:0 0 auto;
  }
  .badge:before{
    content:"";
    position:absolute; inset:-30%;
    background:radial-gradient(circle at 40% 40%, rgba(255,255,255,0.18), transparent 55%);
    transform:rotate(12deg);
  }
  .brand h1{
    font-size:16px; margin:0; letter-spacing:0.6px;
  }
  .brand p{
    margin:0; font-size:12px; color:var(--muted);
  }

  .actions{
    display:flex; gap:10px; align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .btn{
    appearance:none;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.08);
    color:var(--ink);
    padding:10px 12px;
    border-radius:14px;
    cursor:pointer;
    box-shadow:0 10px 28px rgba(0,0,0,0.30);
    transition:transform .15s ease, background .15s ease, border-color .15s ease;
    font-weight:600;
    font-size:12px;
  }
  .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,0.10)}
  .btn:active{transform:translateY(0px) scale(0.99)}
  .btn.primary{
    background:linear-gradient(135deg, rgba(95,194,167,0.28), rgba(60,193,158,0.18));
    border-color:rgba(95,194,167,0.38);
  }
  .btn.danger{
    background:rgba(255,122,122,0.10);
    border-color:rgba(255,122,122,0.30);
  }

  /* Main layout */
  .main{
    flex:1;
    display:grid;
    grid-template-columns: 1.4fr 0.8fr;
    gap:16px;
    padding:0 18px 18px;
    min-height:0;
  }

  /* Left: Darkroom wall + hanging line + photo */
  .wall{
    position:relative;
    border:1px solid var(--border);
    border-radius:22px;
    background:
      radial-gradient(900px 600px at 20% 0%, rgba(255,219,179,0.08), transparent 55%),
      linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    box-shadow:var(--shadow);
    overflow:hidden;
    min-height:0;
    display:flex;
    flex-direction:column;
  }

  /* Rope area */
  .ropeArea{
    position:relative;
    padding:16px 16px 10px;
  }
  .lampGlow{
    position:absolute;
    top:-120px; right:-120px;
    width:320px; height:320px;
    background:radial-gradient(circle at 35% 35%, rgba(255,219,179,0.16), transparent 58%);
    filter:blur(2px);
    pointer-events:none;
  }
  .rope{
    position:relative;
    height:58px;
  }
  .rope:before{
    content:"";
    position:absolute; left:10px; right:10px; top:26px;
    height:3px;
    background:linear-gradient(90deg, rgba(255,219,179,0.45), rgba(255,219,179,0.18));
    border-radius:999px;
    box-shadow:0 8px 16px rgba(0,0,0,0.35);
  }
  .rope:after{
    content:"";
    position:absolute; left:14px; right:14px; top:26px;
    height:1px;
    background:rgba(255,255,255,0.10);
    border-radius:999px;
  }

  /* Clip */
  .clip{
    position:absolute;
    top:7px; left:50%;
    transform:translateX(-50%) rotate(-3deg);
    width:46px; height:34px;
    background:linear-gradient(180deg, rgba(240,240,240,0.75), rgba(180,180,180,0.35));
    border:1px solid rgba(255,255,255,0.26);
    border-radius:10px;
    box-shadow:0 14px 22px rgba(0,0,0,0.35);
    display:flex; align-items:flex-end; justify-content:center;
    padding-bottom:6px;
    z-index:5;
  }
  .clip i{
    display:block; width:26px; height:8px;
    background:rgba(0,0,0,0.25);
    border-radius:99px;
  }

  /* Photo hanging */
  .hanger{
    position:relative;
    height:320px;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding-top:8px;
    flex:0 0 auto;
  }

  .photoCard{
    width:min(560px, 92%);
    height:280px;
    border-radius:18px;
    background:linear-gradient(180deg, rgba(255,255,255,0.11), rgba(255,255,255,0.05));
    border:1px solid var(--border);
    box-shadow:0 18px 60px rgba(0,0,0,0.55);
    position:relative;
    overflow:hidden;
    transform-origin:50% -20%;
    animation: gentleSwing 4.8s ease-in-out infinite;
  }
  @keyframes gentleSwing{
    0%,100%{transform:rotate(-1.4deg)}
    50%{transform:rotate(1.2deg)}
  }

  .photoFrame{
    position:absolute; inset:14px;
    border-radius:14px;
    background:rgba(0,0,0,0.22);
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.10);
  }

  /* Big preview canvas (not squashed; we draw with aspect fit) */
  #bigView{
    width:100%; height:100%;
    display:block;
  }

  /* Crop overlay */
  .cropOverlay{
    position:absolute;
    inset:0;
    pointer-events:none;
  }
  .cropOverlay .shade{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.35);
  }
  .cropOverlay .hole{
    position:absolute;
    left:50%; top:50%;
    width:min(70%, 320px);
    aspect-ratio:1/1;
    transform:translate(-50%,-50%);
    border-radius:18px;
    box-shadow:0 0 0 999px rgba(0,0,0,0.38);
    outline:2px solid rgba(255,255,255,0.18);
    outline-offset:0px;
  }
  .cropOverlay .grid{
    position:absolute;
    left:50%; top:50%;
    width:min(70%, 320px);
    aspect-ratio:1/1;
    transform:translate(-50%,-50%);
    border-radius:18px;
    overflow:hidden;
  }
  .cropOverlay .grid:before,
  .cropOverlay .grid:after{
    content:"";
    position:absolute; inset:0;
    background:
      linear-gradient(to right, rgba(255,255,255,0.12) 1px, transparent 1px) 33.33% 0/33.33% 100%,
      linear-gradient(to right, rgba(255,255,255,0.12) 1px, transparent 1px) 66.66% 0/33.33% 100%,
      linear-gradient(to bottom, rgba(255,255,255,0.12) 1px, transparent 1px) 0 33.33%/100% 33.33%,
      linear-gradient(to bottom, rgba(255,255,255,0.12) 1px, transparent 1px) 0 66.66%/100% 33.33%;
    opacity:0.65;
    mix-blend-mode:screen;
  }

  .hintBar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 16px 14px;
    color:var(--muted);
    font-size:12px;
  }
  .hintBar b{color:var(--ink)}
  .pill{
    display:inline-flex;
    gap:8px; align-items:center;
    padding:8px 10px;
    border-radius:999px;
    background:rgba(255,255,255,0.08);
    border:1px solid var(--border);
  }
  .dot{
    width:8px; height:8px; border-radius:50%;
    background:var(--accent);
    box-shadow:0 0 0 6px rgba(95,194,167,0.12);
  }

  /* Table area (controls) */
  .tableArea{
    margin-top:auto;
    background:linear-gradient(180deg, rgba(0,0,0,0.10), rgba(0,0,0,0.24));
    border-top:1px solid rgba(255,255,255,0.10);
    padding:14px 14px 16px;
  }
  .desk{
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.12);
    background:
      radial-gradient(900px 520px at 20% -40%, rgba(255,219,179,0.10), transparent 55%),
      linear-gradient(180deg, rgba(42,27,18,0.84), rgba(32,19,13,0.86));
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 14px 38px rgba(0,0,0,0.40);
    padding:14px;
  }

  .controls{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:12px;
  }
  .control{
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.06);
    padding:12px;
    position:relative;
    overflow:hidden;
  }
  .control small{
    display:block;
    color:var(--muted);
    margin-bottom:6px;
    font-size:11px;
    letter-spacing:0.3px;
  }
  .control label{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-weight:700;
    font-size:13px;
    margin-bottom:8px;
  }
  .control label span.val{
    font-size:12px;
    color:rgba(255,255,255,0.82);
    font-weight:700;
  }

  input[type="range"]{ width:100%; accent-color: var(--accent); }

  /* Right side: guide + 224 preview */
  .side{
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .card{
    border:1px solid var(--border);
    border-radius:22px;
    background:rgba(255,255,255,0.07);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    padding:14px 14px 10px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    border-bottom:1px solid rgba(255,255,255,0.10);
  }
  .cardHead h2{
    margin:0;
    font-size:14px;
    letter-spacing:0.3px;
  }
  .cardHead p{
    margin:4px 0 0;
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
  }

  .stepBody{ padding:12px 14px 14px; }
  .stepLine{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .stepBadge{
    width:34px; height:34px; border-radius:12px;
    display:grid; place-items:center;
    background:linear-gradient(135deg, rgba(95,194,167,0.24), rgba(255,219,179,0.14));
    border:1px solid rgba(255,255,255,0.14);
    font-weight:900;
  }
  .stepText{ color:rgba(255,255,255,0.86); font-size:13px; line-height:1.45; }
  .stepText b{color:var(--ink)}
  .stepFooter{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

  .preview224{ flex:1; display:flex; flex-direction:column; min-height:0; }
  .polaroid{
    margin:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.22);
    box-shadow:0 16px 45px rgba(0,0,0,0.55);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .polaroid .frame{
    margin:12px;
    border-radius:14px;
    background:rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.12);
    overflow:hidden;
    width:224px;
    height:224px;
    align-self:center;
  }
  #sample224{ width:224px; height:224px; display:block; }
  .polaroid .cap{
    padding:0 14px 14px;
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
    text-align:center;
  }
  .polaroid .cap b{color:var(--ink)}

  /* Wash tray (dip animation) */
  .tray{
    position:absolute;
    left:50%; bottom:12px;
    transform:translateX(-50%);
    width:min(620px, 94%);
    height:54px;
    border-radius:18px;
    background:linear-gradient(180deg, rgba(95,194,167,0.14), rgba(0,0,0,0.18));
    border:1px solid rgba(255,255,255,0.14);
    box-shadow:0 18px 55px rgba(0,0,0,0.55);
    overflow:hidden;
    opacity:0.0;
    pointer-events:none;
  }
  .tray .ripple{
    position:absolute; inset:-60% -10%;
    background:
      radial-gradient(circle at 40% 60%, rgba(255,255,255,0.18), transparent 55%),
      radial-gradient(circle at 70% 35%, rgba(95,194,167,0.18), transparent 60%);
    transform:translateY(40px);
    opacity:0.0;
  }

  /* ‚Äúfly to analysis‚Äù overlay */
  .flyOverlay{
    position:fixed; inset:0;
    pointer-events:none;
    display:none;
    z-index:99999;
  }
  .flyOverlay.show{display:block}
  .flyCard{
    position:absolute;
    width:260px; height:320px;
    border-radius:22px;
    background:rgba(255,255,255,0.10);
    border:1px solid rgba(255,255,255,0.18);
    box-shadow:0 24px 90px rgba(0,0,0,0.75);
    backdrop-filter: blur(10px);
    overflow:hidden;
    transform:translate(-50%,-50%) scale(0.9) rotate(-4deg);
  }
  .flyCard .inner{
    margin:14px;
    border-radius:16px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.28);
    height:232px;
    display:grid;
    place-items:center;
  }
  #flyCanvas{width:224px;height:224px}
  .flyCard .label{
    padding:0 14px 14px;
    text-align:center;
    color:var(--muted);
    font-size:12px;
  }

  /* Pointer interactions for crop/drag */
  .dragShield{
    position:absolute;
    inset:14px;
    border-radius:14px;
    cursor:grab;
    z-index:10;
  }
  .dragShield:active{cursor:grabbing}

  /* Responsive */
  @media (max-width: 980px){
    body{overflow:auto}
    .main{
      grid-template-columns:1fr;
      overflow:auto;
    }
    .wall{min-height: 640px}
    .photoCard{height:300px}
    .hanger{height:340px}
    .preview224 .polaroid .frame{align-self:flex-start; margin-left:auto; margin-right:auto}
  }
</style>
</head>

<body>
<div class="room">

  <div class="topbar">
    <div class="brand">
      <div class="badge" aria-hidden="true">üì∑</div>
      <div>
        <h1>PhotoHouse ‚Ä¢ Darkroom Workroom</h1>
        <p id="subtitle">Developing algae photos for Uniqueseeker‚Äôs Pond</p>
      </div>
    </div>

    <div class="actions">
      <input id="tmpPhotoInput" type="file" accept="image/*" hidden>
      <button class="btn" id="btnAddPhoto" type="button">Add Photo (temporary)</button>

      <button class="btn" id="btnSkip" type="button">Skip guide</button>
      <button class="btn" id="btnReset" type="button">Reset</button>
      <button class="btn primary" id="btnAuto" type="button">Auto Improve</button>
      <button class="btn primary" id="btnDevelop" type="button">Develop ‚Üí Analyze</button>
    </div>
  </div>

  <div class="main">
    <!-- LEFT -->
    <div class="wall">
      <div class="ropeArea">
        <div class="lampGlow"></div>
        <div class="rope">
          <div class="clip"><i></i></div>
        </div>
      </div>

      <div class="hanger">
        <div class="photoCard" id="photoCard">
          <div class="photoFrame">
            <canvas id="bigView"></canvas>
            <div class="cropOverlay" id="cropOverlay">
              <div class="shade"></div>
              <div class="hole"></div>
              <div class="grid"></div>
            </div>
            <div class="dragShield" id="dragShield" title="Drag to position algae inside the square crop"></div>
          </div>
        </div>

        <div class="tray" id="tray">
          <div class="ripple" id="ripple"></div>
        </div>
      </div>

      <div class="hintBar">
        <div class="pill"><span class="dot"></span> <span><b>Tip:</b> keep algae filling ~60‚Äì80% of the square.</span></div>
        <div class="pill" id="fillHint">Model sample: <b>224√ó224</b></div>
      </div>

      <div class="tableArea">
        <div class="desk">
          <div class="controls">
            <div class="control" data-step="1">
              <small>Lens</small>
              <label>Zoom <span class="val" id="vZoom">1.00√ó</span></label>
              <input type="range" id="zoom" min="1" max="4" value="1" step="0.01">
            </div>

            <div class="control" data-step="2">
              <small>Exposure Dial</small>
              <label>Brightness <span class="val" id="vBright">0</span></label>
              <input type="range" id="bright" min="-40" max="40" value="0" step="1">
            </div>

            <div class="control" data-step="3">
              <small>Contrast Lever</small>
              <label>Contrast <span class="val" id="vContrast">1.00√ó</span></label>
              <input type="range" id="contrast" min="0.60" max="1.80" value="1.00" step="0.01">
            </div>

            <div class="control" data-step="4">
              <small>Grain Cleaner</small>
              <label>Denoise <span class="val" id="vDenoise">0</span></label>
              <input type="range" id="denoise" min="0" max="6" value="0" step="1">
            </div>

            <div class="control" data-step="5">
              <small>Focus Tuner</small>
              <label>Sharpen <span class="val" id="vSharpen">0</span></label>
              <input type="range" id="sharpen" min="0" max="6" value="0" step="1">
            </div>

            <div class="control" data-step="0">
              <small>Rotate</small>
              <label>Rotate 90¬∞</label>
              <button class="btn" id="btnRotate" type="button" style="width:100%; border-radius:14px; padding:10px;">Rotate</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="side">
      <div class="card" id="guideCard">
        <div class="cardHead">
          <div>
            <h2>Darkroom Guide</h2>
            <p>We‚Äôll develop this photo step-by-step, like old film days.</p>
          </div>
          <div class="stepBadge" id="stepBadge">0</div>
        </div>
        <div class="stepBody">
          <div class="stepLine">
            <div class="stepBadge" style="width:28px;height:28px;border-radius:10px;font-size:12px" id="stepIcon">üß∑</div>
            <div class="stepText" id="stepText">
              <b>Hang the print.</b> Your algae photo is clipped here. We‚Äôll prepare a clean 224√ó224 sample for analysis.
            </div>
          </div>

          <div class="stepFooter">
            <button class="btn" id="btnPrev" type="button">Back</button>
            <button class="btn primary" id="btnNext" type="button">Next step</button>
          </div>

          <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.45">
            <span id="stepHint">You can also use <b>Auto Improve</b> if you don‚Äôt want manual tuning.</span>
          </div>
        </div>
      </div>

      <div class="card preview224">
        <div class="cardHead">
          <div>
            <h2>Developed Sample</h2>
            <p>This is <b>exactly</b> what the model will analyze (224√ó224).</p>
          </div>
        </div>
        <div class="polaroid">
          <div class="frame">
            <canvas id="sample224" width="224" height="224"></canvas>
          </div>
          <div class="cap">
            <b>Model Input (224√ó224)</b><br/>
            Keep algae centered and clear.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Fly overlay -->
<div class="flyOverlay" id="flyOverlay">
  <div class="flyCard" id="flyCard">
    <div class="inner">
      <canvas id="flyCanvas" width="224" height="224"></canvas>
    </div>
    <div class="label">Sending developed sample to analysis‚Ä¶</div>
  </div>
</div>

<script>
/* =========================
   SETTINGS YOU CAN CHANGE LATER
========================= */
const WORKROOM_NAME = "Uniqueseeker‚Äôs Project Mate"; // change anytime
const PAGE5_URL = "page4.html"; // testing loop (change later)
const KEY_INPUT = "pond2_upload_image";    // set in Page 3
const KEY_OUTPUT = "pond2_enhanced_224";   // read in Page 5

document.getElementById("subtitle").textContent =
  `${WORKROOM_NAME} ‚Ä¢ developing algae photos collected from Earth`;

/* =========================
   STATE
========================= */
const bigCanvas = document.getElementById("bigView");
const bigCtx = bigCanvas.getContext("2d", { willReadFrequently: false });

const sampleCanvas = document.getElementById("sample224");
const sampleCtx = sampleCanvas.getContext("2d", { willReadFrequently: true });

const flyCanvas = document.getElementById("flyCanvas");
const flyCtx = flyCanvas.getContext("2d", { willReadFrequently: true });

const dragShield = document.getElementById("dragShield");
const photoCard = document.getElementById("photoCard");

const tray = document.getElementById("tray");
const ripple = document.getElementById("ripple");

const sliders = {
  zoom: document.getElementById("zoom"),
  bright: document.getElementById("bright"),
  contrast: document.getElementById("contrast"),
  denoise: document.getElementById("denoise"),
  sharpen: document.getElementById("sharpen"),
};

const vals = {
  zoom: document.getElementById("vZoom"),
  bright: document.getElementById("vBright"),
  contrast: document.getElementById("vContrast"),
  denoise: document.getElementById("vDenoise"),
  sharpen: document.getElementById("vSharpen"),
};

let img = new Image();
img.crossOrigin = "anonymous";
let imgReady = false;

// crop controls
let panX = 0;
let panY = 0;
let isDragging = false;
let lastX = 0;
let lastY = 0;

// rotation
let rotation = 0;

// guide steps
let guideEnabled = true;
let step = 0;
const steps = [
  { id:0, icon:"üß∑", title:"Hang the print.", text:"Your algae photo is clipped here. We‚Äôll prepare a clean <b>224√ó224</b> sample for analysis.", enable:[] },
  { id:1, icon:"üîé", title:"Crop & zoom.", text:"Drag the photo so algae sits inside the square. Zoom until algae fills <b>60‚Äì80%</b> of the box.", enable:["zoom"] },
  { id:2, icon:"üîÜ", title:"Exposure (brightness).", text:"If the image is dark, increase brightness a little. Stop before whites look washed out.", enable:["bright"] },
  { id:3, icon:"üéöÔ∏è", title:"Contrast.", text:"Add contrast so structures pop. Don‚Äôt overdo it‚Äîkeep details natural.", enable:["contrast"] },
  { id:4, icon:"üßº", title:"Clean grain (denoise).", text:"Use mild denoise if the background is noisy. Too much can blur cell edges.", enable:["denoise"] },
  { id:5, icon:"‚ú®", title:"Focus (sharpen).", text:"Tiny sharpen can help. Too much creates fake edges (bad for science). Keep it mild.", enable:["sharpen"] },
  { id:6, icon:"üöÄ", title:"Develop & send.", text:"Looks good. Press <b>Develop ‚Üí Analyze</b> to send this sample to the model page.", enable:[] },
];

function setStep(newStep){
  step = Math.max(0, Math.min(steps.length-1, newStep));
  const s = steps[step];
  document.getElementById("stepBadge").textContent = s.id;
  document.getElementById("stepIcon").textContent = s.icon;
  document.getElementById("stepText").innerHTML = `<b>${s.title}</b> ${s.text}`;

  const enabled = new Set(s.enable);
  for (const [k, el] of Object.entries(sliders)){
    if (!guideEnabled){
      el.disabled = false;
      el.parentElement.style.opacity = 1;
      continue;
    }
    const canUse = enabled.has(k) || step === 6 || step === 0;
    el.disabled = !canUse;
    el.parentElement.style.opacity = canUse ? 1 : 0.45;
  }
}

function enableAllControls(){
  for (const el of Object.values(sliders)){
    el.disabled = false;
    el.parentElement.style.opacity = 1;
  }
}

function updateValueLabels(){
  vals.zoom.textContent = `${Number(sliders.zoom.value).toFixed(2)}√ó`;
  vals.bright.textContent = `${Number(sliders.bright.value)}`;
  vals.contrast.textContent = `${Number(sliders.contrast.value).toFixed(2)}√ó`;
  vals.denoise.textContent = `${Number(sliders.denoise.value)}`;
  vals.sharpen.textContent = `${Number(sliders.sharpen.value)}`;
}

/* Canvas sizing */
function sizeBigCanvas(){
  const frame = bigCanvas.parentElement.getBoundingClientRect();
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  bigCanvas.width = Math.floor(frame.width * dpr);
  bigCanvas.height = Math.floor(frame.height * dpr);
  bigCanvas.style.width = frame.width + "px";
  bigCanvas.style.height = frame.height + "px";
  bigCtx.setTransform(dpr,0,0,dpr,0,0);
  renderAll();
}
window.addEventListener("resize", sizeBigCanvas);

/* Image helpers */
function getRotatedCanvas(){
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  const w = img.naturalWidth;
  const h = img.naturalHeight;
  const rot = ((rotation % 360) + 360) % 360;

  if (rot === 0 || rot === 180){ c.width = w; c.height = h; }
  else { c.width = h; c.height = w; }

  ctx.save();
  ctx.translate(c.width/2, c.height/2);
  ctx.rotate(rot * Math.PI/180);
  ctx.drawImage(img, -w/2, -h/2);
  ctx.restore();
  return c;
}

function applyBC(imageData, brightness, contrast){
  const data = imageData.data;
  const b = brightness * 2.55;
  const c = contrast;
  for (let i=0; i<data.length; i+=4){
    let r = data[i], g = data[i+1], bl = data[i+2];
    r = (r - 128) * c + 128 + b;
    g = (g - 128) * c + 128 + b;
    bl = (bl - 128) * c + 128 + b;
    data[i]   = Math.max(0, Math.min(255, r));
    data[i+1] = Math.max(0, Math.min(255, g));
    data[i+2] = Math.max(0, Math.min(255, bl));
  }
  return imageData;
}

function denoiseBoxBlur(srcCtx, w, h, strength){
  if (strength <= 0) return;
  const passes = Math.min(2, Math.ceil(strength / 3));
  const radius = strength <= 2 ? 1 : strength <= 4 ? 2 : 3;

  for (let p=0; p<passes; p++){
    const id = srcCtx.getImageData(0,0,w,h);
    const out = srcCtx.createImageData(w,h);
    const d = id.data, o = out.data;

    const rs = radius;
    const area = (2*rs+1)*(2*rs+1);

    for (let y=0; y<h; y++){
      for (let x=0; x<w; x++){
        let r=0,g=0,b=0,a=0;
        for (let yy=y-rs; yy<=y+rs; yy++){
          const cy = Math.max(0, Math.min(h-1, yy));
          for (let xx=x-rs; xx<=x+rs; xx++){
            const cx = Math.max(0, Math.min(w-1, xx));
            const idx = (cy*w + cx)*4;
            r += d[idx]; g += d[idx+1]; b += d[idx+2]; a += d[idx+3];
          }
        }
        const oi = (y*w + x)*4;
        o[oi]   = r/area;
        o[oi+1] = g/area;
        o[oi+2] = b/area;
        o[oi+3] = a/area;
      }
    }
    srcCtx.putImageData(out,0,0);
  }
}

function sharpenUnsharp(srcCtx, w, h, strength){
  if (strength <= 0) return;
  const s = Math.min(6, strength);
  const amount = 0.10 + s*0.07;

  const temp = document.createElement("canvas");
  temp.width=w; temp.height=h;
  const tctx = temp.getContext("2d");
  tctx.drawImage(srcCtx.canvas,0,0);
  denoiseBoxBlur(tctx, w, h, 2);

  const orig = srcCtx.getImageData(0,0,w,h);
  const blur = tctx.getImageData(0,0,w,h);
  const o = orig.data, b = blur.data;

  for (let i=0; i<o.length; i+=4){
    o[i]   = Math.max(0, Math.min(255, o[i]   + amount*(o[i]   - b[i])));
    o[i+1] = Math.max(0, Math.min(255, o[i+1] + amount*(o[i+1] - b[i+1])));
    o[i+2] = Math.max(0, Math.min(255, o[i+2] + amount*(o[i+2] - b[i+2])));
  }
  srcCtx.putImageData(orig,0,0);
}

/* Rendering */
function renderAll(){
  if (!imgReady) return;
  updateValueLabels();

  const frame = bigCanvas.getBoundingClientRect();
  const fw = frame.width, fh = frame.height;
  bigCtx.clearRect(0,0,fw,fh);

  const grd = bigCtx.createRadialGradient(fw*0.5, fh*0.45, 10, fw*0.5, fh*0.5, Math.max(fw,fh)*0.7);
  grd.addColorStop(0, "rgba(255,255,255,0.06)");
  grd.addColorStop(1, "rgba(0,0,0,0.35)");
  bigCtx.fillStyle = grd;
  bigCtx.fillRect(0,0,fw,fh);

  const rotC = getRotatedCanvas();
  const iw = rotC.width, ih = rotC.height;

  const scaleFit = Math.min(fw/iw, fh/ih);
  const drawW = iw * scaleFit;
  const drawH = ih * scaleFit;
  const x0 = (fw - drawW)/2;
  const y0 = (fh - drawH)/2;

  renderAll._map = { x0, y0, drawW, drawH, iw, ih };
  bigCtx.drawImage(rotC, x0, y0, drawW, drawH);

  bigCtx.fillStyle = "rgba(255,255,255,0.04)";
  bigCtx.fillRect(0,0,fw,fh);

  renderSample224();
}

function renderSample224(){
  if (!imgReady || !renderAll._map) return;

  const { x0, y0, drawW, drawH, iw, ih } = renderAll._map;
  const zoom = Number(sliders.zoom.value);

  const frame = bigCanvas.getBoundingClientRect();
  const fw = frame.width, fh = frame.height;

  const cropSize = Math.min(fw*0.70, 320);
  const panPxX = panX * drawW;
  const panPxY = panY * drawH;

  const sampleW = cropSize / zoom;
  const sampleH = cropSize / zoom;

  const centerOnFitX = x0 + drawW/2 + panPxX;
  const centerOnFitY = y0 + drawH/2 + panPxY;

  const fitSampleX = centerOnFitX - sampleW/2;
  const fitSampleY = centerOnFitY - sampleH/2;

  const sx = (fitSampleX - x0) / drawW * iw;
  const sy = (fitSampleY - y0) / drawH * ih;
  const sw = (sampleW / drawW) * iw;
  const sh = (sampleH / drawH) * ih;

  const csx = Math.max(0, Math.min(iw - sw, sx));
  const csy = Math.max(0, Math.min(ih - sh, sy));

  const off = document.createElement("canvas");
  off.width = 224; off.height = 224;
  const octx = off.getContext("2d", { willReadFrequently:true });

  const rotC = getRotatedCanvas();
  octx.drawImage(rotC, csx, csy, sw, sh, 0, 0, 224, 224);

  let id = octx.getImageData(0,0,224,224);
  id = applyBC(id, Number(sliders.bright.value), Number(sliders.contrast.value));
  octx.putImageData(id,0,0);

  denoiseBoxBlur(octx, 224, 224, Number(sliders.denoise.value));
  sharpenUnsharp(octx, 224, 224, Number(sliders.sharpen.value));

  sampleCtx.clearRect(0,0,224,224);
  sampleCtx.drawImage(off,0,0);

  flyCtx.clearRect(0,0,224,224);
  flyCtx.drawImage(off,0,0);
}

/* Drag handling */
function clampPan(){
  const limit = 0.45;
  panX = Math.max(-limit, Math.min(limit, panX));
  panY = Math.max(-limit, Math.min(limit, panY));
}
dragShield.addEventListener("pointerdown", (e)=>{
  if (!imgReady) return;
  isDragging = true;
  lastX = e.clientX;
  lastY = e.clientY;
  dragShield.setPointerCapture(e.pointerId);
});
dragShield.addEventListener("pointermove", (e)=>{
  if (!isDragging) return;
  const dx = e.clientX - lastX;
  const dy = e.clientY - lastY;
  lastX = e.clientX;
  lastY = e.clientY;
  if (renderAll._map){
    const { drawW, drawH } = renderAll._map;
    panX += dx / Math.max(1, drawW);
    panY += dy / Math.max(1, drawH);
    clampPan();
    renderAll();
  }
});
dragShield.addEventListener("pointerup", (e)=>{
  isDragging = false;
  try{ dragShield.releasePointerCapture(e.pointerId); }catch(_){}
});

/* Slider events */
for (const el of Object.values(sliders)){
  el.addEventListener("input", renderAll);
}

/* Buttons */
document.getElementById("btnRotate").addEventListener("click", ()=>{
  rotation = (rotation + 90) % 360;
  renderAll();
});

document.getElementById("btnReset").addEventListener("click", ()=>{
  sliders.zoom.value = 1;
  sliders.bright.value = 0;
  sliders.contrast.value = 1.0;
  sliders.denoise.value = 0;
  sliders.sharpen.value = 0;
  panX = 0; panY = 0;
  rotation = 0;
  renderAll();
});

document.getElementById("btnSkip").addEventListener("click", ()=>{
  guideEnabled = !guideEnabled;
  if (!guideEnabled){
    document.getElementById("btnSkip").textContent = "Guide: OFF";
    enableAllControls();
  } else {
    document.getElementById("btnSkip").textContent = "Skip guide";
    setStep(step);
  }
});

document.getElementById("btnPrev").addEventListener("click", ()=> setStep(step - 1));
document.getElementById("btnNext").addEventListener("click", ()=>{
  setStep(step + 1);
  if (step === 1 || step === 2) playDipAnimation();
});

document.getElementById("btnAuto").addEventListener("click", ()=>{
  sliders.bright.value = Math.max(-40, Math.min(40, Number(sliders.bright.value) + 10));
  sliders.contrast.value = Math.max(0.60, Math.min(1.80, Number(sliders.contrast.value) + 0.10));
  sliders.denoise.value = Math.max(0, Math.min(6, Number(sliders.denoise.value) + 2));
  sliders.sharpen.value = Math.max(0, Math.min(6, Number(sliders.sharpen.value) + 1));
  renderAll();
  playDipAnimation();
});

document.getElementById("btnDevelop").addEventListener("click", ()=>{
  if (!imgReady){
    alert("No image loaded yet. Use Add Photo (temporary) or upload from Page 3.");
    return;
  }
  const dataUrl = sampleCanvas.toDataURL("image/png");
  localStorage.setItem(KEY_OUTPUT, dataUrl);
  playFlyToAnalysis(() => window.location.href = PAGE5_URL);
});

/* Animations */
function playDipAnimation(){
  tray.style.opacity = "1";
  ripple.style.opacity = "1";
  ripple.style.transition = "none";
  ripple.style.transform = "translateY(40px)";

  photoCard.style.transition = "transform .55s ease";
  photoCard.style.transform = "translateY(42px) rotate(-1deg)";

  requestAnimationFrame(()=>{
    ripple.style.transition = "transform .9s ease, opacity .9s ease";
    ripple.style.transform = "translateY(0px)";
    ripple.style.opacity = "0.9";
  });

  setTimeout(()=>{
    photoCard.style.transform = "translateY(0px) rotate(0.5deg)";
    setTimeout(()=>{
      photoCard.style.transition = "";
      photoCard.style.transform = "";
      tray.style.opacity = "0";
      ripple.style.opacity = "0";
    }, 520);
  }, 520);
}

function playFlyToAnalysis(done){
  const overlay = document.getElementById("flyOverlay");
  const flyCard = document.getElementById("flyCard");

  const sampleRect = sampleCanvas.getBoundingClientRect();
  const startX = sampleRect.left + sampleRect.width/2;
  const startY = sampleRect.top + sampleRect.height/2;

  overlay.classList.add("show");
  flyCard.style.left = startX + "px";
  flyCard.style.top  = startY + "px";

  const endX = window.innerWidth/2;
  const endY = window.innerHeight/2;

  flyCard.animate([
    { transform:"translate(-50%,-50%) scale(0.90) rotate(-4deg)", filter:"blur(0px)", opacity:1 },
    { transform:"translate(-50%,-50%) scale(1.08) rotate(2deg)",  filter:"blur(0px)", opacity:1, offset:0.7 },
    { transform:"translate(-50%,-50%) scale(1.35) rotate(0deg)",  filter:"blur(1.5px)", opacity:0.0 }
  ], { duration: 920, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards" });

  flyCard.animate([
    { left: startX+"px", top: startY+"px" },
    { left: endX+"px",   top: endY+"px" }
  ], { duration: 920, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards" });

  const flash = document.createElement("div");
  flash.style.position="fixed";
  flash.style.inset="0";
  flash.style.background="radial-gradient(circle at 50% 45%, rgba(95,194,167,0.30), rgba(255,255,255,0.10), transparent 60%)";
  flash.style.opacity="0";
  flash.style.pointerEvents="none";
  flash.style.zIndex="999999";
  document.body.appendChild(flash);

  flash.animate([{opacity:0},{opacity:1,offset:0.35},{opacity:0}], { duration: 920, easing:"ease-out", fill:"forwards" });

  setTimeout(()=>{
    overlay.classList.remove("show");
    flash.remove();
    done && done();
  }, 930);
}

/* Load image from Page 3 */
function loadFromStorage(){
  const dataUrl = localStorage.getItem(KEY_INPUT);
  if (!dataUrl){
    document.getElementById("stepText").innerHTML =
      "<b>No photo found.</b> Use <b>Add Photo (temporary)</b> to test, or upload from Page 3 later.";
    return;
  }
  img.onload = () => {
    imgReady = true;
    sizeBigCanvas();
    renderAll();
    setStep(0);
  };
  img.onerror = () => {
    document.getElementById("stepText").innerHTML =
      "<b>Photo failed to load.</b> Try uploading again.";
  };
  img.src = dataUrl;
}

/* TEMP uploader: Add Photo (temporary) */
const tmpPhotoInput = document.getElementById("tmpPhotoInput");
const btnAddPhoto = document.getElementById("btnAddPhoto");

btnAddPhoto.addEventListener("click", () => {
  // must be directly in a click handler (user gesture) for browser to allow picker
  tmpPhotoInput.value = "";
  tmpPhotoInput.click();
});

tmpPhotoInput.addEventListener("change", (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  if (file.size > 10 * 1024 * 1024){
    alert("Image too large. Please choose a photo under 10MB.");
    return;
  }

  const r = new FileReader();
  r.onload = () => {
    localStorage.setItem(KEY_INPUT, r.result);
    imgReady = false;

    img.onload = () => {
      imgReady = true;
      sliders.zoom.value = 1;
      sliders.bright.value = 0;
      sliders.contrast.value = 1.0;
      sliders.denoise.value = 0;
      sliders.sharpen.value = 0;
      panX = 0; panY = 0;
      rotation = 0;

      sizeBigCanvas();
      renderAll();
      setStep(0);
    };
    img.src = r.result;
  };
  r.readAsDataURL(file);
});

loadFromStorage();
setStep(0);
</script>
</body>
</html>
