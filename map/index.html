<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kerala Algae Map (3D Districts)</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,0.95);
      --shadow:0 12px 30px rgba(0,0,0,0.35);
    }
    body { margin:0; overflow:hidden; font-family: system-ui, Arial; background:var(--bg); }
    #info {
      position: fixed; right: 16px; top: 16px;
      width: 320px; max-height: 78vh; overflow:auto;
      background: var(--card);
      padding: 12px 14px; border-radius: 14px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.08);
    }
    #info h3 { margin: 0 0 6px; font-size: 18px; }
    #info small { display:block; color:#444; margin-bottom:10px; line-height: 1.3; }
    #info ul { margin: 6px 0 0 18px; }
    #hint {
      position: fixed; left: 16px; bottom: 16px;
      background: rgba(255,255,255,0.10);
      color: #e8f0ff; padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 12px;
      backdrop-filter: blur(8px);
      max-width: 60vw;
    }
    #topbar{
      position: fixed; left: 16px; top: 16px;
      display:flex; gap:10px; align-items:center;
      color:#e8f0ff;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 12px;
      padding: 10px 12px;
      backdrop-filter: blur(8px);
    }
    #topbar a{
      color:#e8f0ff; text-decoration:none;
      border-bottom: 1px dashed rgba(255,255,255,0.4);
    }
    button{
      cursor:pointer; border:none; border-radius:10px;
      padding:8px 10px; font-weight:600;
      background:rgba(255,255,255,0.18); color:#e8f0ff;
    }
    button:hover{ background:rgba(255,255,255,0.25); }
  </style>

  <!-- ✅ IMPORTANT FIX: Import map so "three" resolves in browser -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>
  <div id="topbar">
    <b>Kerala 3D Algae Map</b>
    <span style="opacity:.8">•</span>
    <a href="../" title="Back to main site">Back</a>
    <button id="resetBtn" title="Reset camera">Reset View</button>
  </div>

  <div id="info">
    <h3>Tap a district</h3>
    <small>Click/touch a district to see algae list. You can edit algae names inside the code anytime.</small>
    <div id="details">Waiting…</div>
  </div>

  <div id="hint">Drag to rotate • Scroll/pinch to zoom • Tap district</div>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";

    // ✅ Edit algae list here
    const algaeByDistrict = {
      "Thiruvananthapuram": ["Spirogyra", "Nostoc"],
      "Kollam": ["Cladophora", "Scenedesmus"],
      "Pathanamthitta": ["Cosmarium", "Staurastrum"],
      "Alappuzha": ["Nostoc", "Pediastrum"],
      "Kottayam": ["Spirogyra", "Volvox"],
      "Idukki": ["Desmids (Cosmarium)", "Staurastrum"],
      "Ernakulam": ["Cladophora", "Scenedesmus"],
      "Thrissur": ["Spirogyra", "Pediastrum"],
      "Palakkad": ["Oedogonium", "Scenedesmus"],
      "Malappuram": ["Spirogyra", "Nostoc"],
      "Kozhikode": ["Cosmarium", "Cladophora"],
      "Wayanad": ["Desmids", "Volvox"],
      "Kannur": ["Cladophora", "Scenedesmus"],
      "Kasaragod": ["Spirogyra", "Nostoc"],
    };

    // Scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b1220);
    scene.fog = new THREE.Fog(0x0b1220, 250, 900);

    const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 5000);
    const defaultCamPos = new THREE.Vector3(0, 180, 240);
    camera.position.copy(defaultCamPos);

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.minDistance = 120;
    controls.maxDistance = 900;

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.75));
    const sun = new THREE.DirectionalLight(0xffffff, 0.85);
    sun.position.set(200, 400, 150);
    scene.add(sun);

    // Base
    const base = new THREE.Mesh(
      new THREE.PlaneGeometry(1400, 1400),
      new THREE.MeshStandardMaterial({ color: 0x0e1b2e, roughness: 1 })
    );
    base.rotation.x = -Math.PI/2;
    base.position.y = -2;
    scene.add(base);

    // Raycaster
    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();
    const clickable = [];

    // Unique color for each district
    function colorFromName(name){
      let hash = 0;
      for (let i=0;i<name.length;i++) hash = name.charCodeAt(i) + ((hash<<5)-hash);
      const hue = Math.abs(hash) % 360;
      return new THREE.Color(`hsl(${hue},70%,55%)`);
    }

    // Simple projection lon/lat -> x/y
    function projectLonLat(lon, lat){
      const scale = 12;
      return new THREE.Vector2(lon*scale, lat*scale);
    }

    // Load GeoJSON (same folder)
    const geo = await fetch("./kerala_districts.geojson").then(r => r.json());

    const group = new THREE.Group();
    scene.add(group);

    for (const f of geo.features){
      const name = f.properties?.shapeName || "Unknown";
      const geom = f.geometry;

      const polys = (geom.type === "Polygon") ? [geom.coordinates]
                  : (geom.type === "MultiPolygon") ? geom.coordinates
                  : [];

      for (const poly of polys){
        const outer = poly[0];
        const shapePts = outer.map(([lon,lat]) => projectLonLat(lon,lat));
        const shape = new THREE.Shape(shapePts);

        const extrudeGeo = new THREE.ExtrudeGeometry(shape, { depth: 10, bevelEnabled:false });

        const mat = new THREE.MeshStandardMaterial({
          color: colorFromName(name),
          roughness: 0.75,
          metalness: 0.05,
          emissive: new THREE.Color(0x000000)
        });

        const mesh = new THREE.Mesh(extrudeGeo, mat);
        mesh.rotation.x = -Math.PI/2;
        mesh.userData = { name };

        group.add(mesh);
        clickable.push(mesh);
      }
    }

    // Center automatically
    const bbox = new THREE.Box3().setFromObject(group);
    const center = new THREE.Vector3();
    bbox.getCenter(center);
    group.position.sub(center);

    // UI
    const infoTitle = document.querySelector("#info h3");
    const details = document.querySelector("#details");

    function setInfo(name){
      const list = algaeByDistrict[name] || ["No data yet (we will fill)"];
      infoTitle.textContent = name;
      details.innerHTML = `<b>Common algae:</b><ul>${list.map(a=>`<li>${a}</li>`).join("")}</ul>`;
    }

    // Click highlight
    let lastPicked = null;
    const highlightEmissive = new THREE.Color(0x222222);
    const noEmissive = new THREE.Color(0x000000);

    function onPointerDown(e){
      const rect = renderer.domElement.getBoundingClientRect();
      pointer.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      pointer.y = -(((e.clientY - rect.top) / rect.height) * 2 - 1);

      raycaster.setFromCamera(pointer, camera);
      const hits = raycaster.intersectObjects(clickable, true);

      if (hits.length){
        const obj = hits[0].object;
        const name = obj.userData.name;

        if (lastPicked) lastPicked.material.emissive.copy(noEmissive);
        obj.material.emissive.copy(highlightEmissive);
        lastPicked = obj;

        setInfo(name);
      }
    }

    window.addEventListener("pointerdown", onPointerDown, { passive:true });

    // Reset button
    document.getElementById("resetBtn").addEventListener("click", () => {
      camera.position.copy(defaultCamPos);
      controls.target.set(0,0,0);
      controls.update();
    });

    // Resize
    window.addEventListener("resize", () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    // Loop
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
