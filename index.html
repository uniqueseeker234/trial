<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Algae Identifier üåø</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">

  <style>
    body { 
      background-color: #E8F5E9; 
      font-family: 'Montserrat', sans-serif;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    button.btn-success { 
      background-color: #2E7D32; 
      border: none; 
    }
    img.example { 
      border-radius: 10px; 
      width: 100%; 
    }
    #stars span { cursor: pointer; font-size: 24px; margin: 0 2px; }
  </style>
</head>
<body>

<div class="container mt-5 text-center">
  <h1 class="mb-4">Algae Identifier üåø</h1>

  <!-- Upload Card -->
  <div class="card p-4">
    <input type="file" class="form-control" id="imageUpload" accept="image/*">
    <div id="message" class="text-success mt-2">Upload your algae photo to start!</div>
  </div>

  <!-- Prediction Card -->
  <div id="result" class="card p-3 d-none">
    <h3 id="predictedName"></h3>
    <p id="confidence"></p>
    <p id="description"></p>

    <!-- Carousel for example images -->
    <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner" id="carouselInner"></div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  </div>

  <!-- Star Rating -->
  <div id="stars" class="my-3">
    <span onclick="rate(1)">‚≠ê</span>
    <span onclick="rate(2)">‚≠ê</span>
    <span onclick="rate(3)">‚≠ê</span>
    <span onclick="rate(4)">‚≠ê</span>
    <span onclick="rate(5)">‚≠ê</span>
  </div>

  <!-- Contribute and Gallery Buttons -->
  <button class="btn btn-success mb-2" onclick="window.location.href='mailto:your_email@example.com?subject=Algae Contribution'">
    Contribute üì®
  </button>
  <a href="gallery.html" class="btn btn-outline-success">Explore Algae Around the World üåè</a>
</div>

<!-- TensorFlow & Teachable Machine JS -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ‚úÖ Model folder
const MODEL_URL = "my_model/"; 

let model, maxPredictions;

// 4-algae info
const algaeInfo = {
  "Cladophora": {
    description: `‚Ä¢ Filamentous green algae forming dense mats.
‚Ä¢ Branching filaments with coarse texture.
‚Ä¢ Commonly grows in clean freshwater.
Economic importance:
‚Ä¢ Used in wastewater treatment.
‚Ä¢ Source of bioactive compounds.
Location: Freshwater ponds and rivers, Kerala.`,
    images: ["images/cladophora1.jpg","images/cladophora2.jpg"]
  },
  "Oedogonium": {
    description: `‚Ä¢ Filamentous green algae with unbranched filaments.
‚Ä¢ Grows attached to submerged plants or stones.
Economic importance:
‚Ä¢ Fish feed in aquaculture.
‚Ä¢ Produces oxygen improving water quality.
Location: Ponds, lakes, slow streams, Kerala.`,
    images: ["images/oedogonium1.jpg","images/oedogonium2.jpg"]
  },
  "Spirogyra": {
    description: `‚Ä¢ Filamentous green algae with spiral chloroplasts.
‚Ä¢ Forms floating green mats in freshwater.
Economic importance:
‚Ä¢ Used in labs for study.
‚Ä¢ Produces oxygen.
Location: Stagnant ponds and ditches, Kerala.`,
    images: ["images/spirogyra1.jpg","images/spirogyra2.jpg"]
  },
  "Cosmarium": {
    description: `‚Ä¢ Green desmid with symmetrical cells and constriction in the middle.
Economic importance:
‚Ä¢ Bioindicator for ecology.
‚Ä¢ Source of pigments.
Location: Freshwater ponds and marshes, Kerala.`,
    images: ["images/cosmarium1.jpg","images/cosmarium2.jpg"]
  }
};

// Load Teachable Machine model
async function init() {
  try {
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    maxPredictions = model.getTotalClasses();
    console.log("Model loaded successfully!");
  } catch (err) {
    console.error("Error loading model:", err);
    document.getElementById("message").innerText = "Failed to load model. Check console.";
  }
}
init();

// Star rating
function rate(star){
  alert("Thanks for giving " + star + " stars!");
  localStorage.setItem("rating", star);
}

// Handle Image Upload
document.getElementById("imageUpload").addEventListener("change", async function(){
  const file = this.files[0];
  if(!file) return;

  document.getElementById("message").innerText = "Scanning the pond for your algae üåøüíß ‚Ä¶ almost done!";
  document.getElementById("result").classList.add("d-none");

  const img = new Image();
  img.src = URL.createObjectURL(file); 
  img.onload = async () => {
    try {
      const prediction = await model.predict(img);
      const topPred = prediction.reduce((a,b)=>a.probability>b.probability?a:b);
      console.log("Model predicted class:", topPred.className); // debug line

      // ‚úÖ Safe match using includes for extra text / lowercase
      const algaeKey = Object.keys(algaeInfo).find(
        key => topPred.className.toLowerCase().includes(key.toLowerCase())
      );

      if (algaeKey) {
        document.getElementById("predictedName").innerText = topPred.className;
        document.getElementById("confidence").innerText = "Confidence: " + (topPred.probability*100).toFixed(2) + "%";
        document.getElementById("description").innerText = algaeInfo[algaeKey].description;

        // Carousel
        const carouselInner = document.getElementById("carouselInner");
        carouselInner.innerHTML = "";
        algaeInfo[algaeKey].images.forEach((src, i) => {
          carouselInner.innerHTML += `<div class="carousel-item ${i===0?'active':''}">
            <img src="${src}" class="d-block w-100 example">
          </div>`;
        });

        document.getElementById("result").classList.remove("d-none");
        document.getElementById("message").innerText = "Thanks for checking your algae! üåø We hope this helps üôÇ";

      } else {
        // Fallback if class not in algaeInfo
        document.getElementById("predictedName").innerText = topPred.className;
        document.getElementById("confidence").innerText = "Confidence: " + (topPred.probability*100).toFixed(2) + "%";
        document.getElementById("description").innerText = "Description not available for this algae.";
        document.getElementById("carouselInner").innerHTML = "";
        document.getElementById("result").classList.remove("d-none");
        document.getElementById("message").innerText = "Prediction done, but we don‚Äôt have info for this algae yet üôÇ";
      }

    } catch(err){
      console.error("Prediction error:", err);
      document.getElementById("message").innerText = "Failed to predict. Check console for errors.";
    }
  }
});
</script>

</body>
</html>
