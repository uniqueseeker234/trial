<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pond 2 ‚Ä¢ UniqueSeeker‚Äôs Algae Pond</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>

<style>
  :root{
    --waterA:#5FC2A7;
    --waterB:#3CC19E;
    --waterC:#148B86;

    --glass: rgba(255,255,255,0.12);
    --glass2: rgba(255,255,255,0.18);
    --border: rgba(255,255,255,0.22);
    --text: rgba(255,255,255,0.92);
    --shadow: 0 18px 45px rgba(0,0,0,0.30);
  }

  html,body{
    margin:0;height:100%;
    font-family:Poppins,system-ui,Arial;
    overflow-x:hidden;
    background:#051b1a;
  }
  body{position:relative;color:var(--text);}

  /* ====== BACKGROUND ====== */
  .pond-bg{
    position:fixed; inset:0;
    z-index:0;
    overflow:hidden;
    background: linear-gradient(to bottom,
      var(--waterA) 0%,
      var(--waterB) 45%,
      var(--waterC) 100%);
  }

  .pond-bg::before{
    content:"";
    position:absolute; inset:-25%;
    background:
      radial-gradient(1100px 520px at 50% 18%, rgba(255,255,255,0.20), transparent 62%),
      radial-gradient(820px 320px at 18% 30%, rgba(255,255,255,0.12), transparent 60%),
      radial-gradient(820px 320px at 82% 32%, rgba(255,255,255,0.10), transparent 60%),
      linear-gradient(to bottom, rgba(255,255,255,0.14), rgba(255,255,255,0.02) 35%, transparent 70%);
    opacity:0.9;
    animation: shimmer 7s ease-in-out infinite alternate;
    pointer-events:none;
  }
  @keyframes shimmer{
    from{ transform: translate3d(-1.2%, -0.6%, 0) scale(1.02); }
    to  { transform: translate3d( 1.2%,  0.6%, 0) scale(1.03); }
  }

  .pond-bg::after{
    content:"";
    position:absolute; inset:0;
    background:
      linear-gradient(110deg, transparent 0%, rgba(255,255,255,0.07) 30%, transparent 55%),
      linear-gradient(75deg,  transparent 0%, rgba(255,255,255,0.05) 35%, transparent 60%);
    mix-blend-mode: overlay;
    opacity:0.55;
    animation: rays 9s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes rays{
    0%,100%{ transform: translateY(-10px) translateX(-10px); opacity:0.45; }
    50%    { transform: translateY( 10px) translateX( 10px); opacity:0.65; }
  }

  .surface-band{
    position:absolute; left:0; right:0;
    top: 18vh;
    height: 10vh;
    background: linear-gradient(to bottom,
      rgba(255,255,255,0.20),
      rgba(255,255,255,0.09),
      rgba(255,255,255,0.02),
      transparent);
    opacity:0.85;
    pointer-events:none;
  }
  .surface-wave{
    position:absolute; left:-10%; right:-10%;
    top: 19vh;
    height: 7vh;
    background:
      radial-gradient(140px 20px at 10% 60%, rgba(255,255,255,0.16), transparent 72%),
      radial-gradient(160px 22px at 35% 40%, rgba(255,255,255,0.12), transparent 74%),
      radial-gradient(150px 20px at 60% 65%, rgba(255,255,255,0.11), transparent 74%),
      radial-gradient(160px 22px at 85% 45%, rgba(255,255,255,0.10), transparent 74%);
    animation: surfaceMove 6s ease-in-out infinite alternate;
    opacity:0.7;
    pointer-events:none;
  }
  @keyframes surfaceMove{
    from{ transform: translateX(-1.5%); }
    to  { transform: translateX(1.5%); }
  }

  /* ====== TOP HUD ====== */
  .topbar{
    position:fixed; left:14px; right:14px; top:12px;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
    z-index:50;
    pointer-events:none;
  }
  .pill{
    pointer-events:auto;
    background: rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 999px;
    padding: 10px 14px;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.20);
    display:flex; align-items:center; gap:10px;
    font-weight:700;
  }
  .right-pills{ display:flex; gap:10px; }
  .pill a, .pill button{
    all:unset;
    cursor:pointer;
    color:var(--text);
    font-weight:800;
  }

  /* ====== INTRO TEXT ====== */
  .intro{
    position:fixed; inset:0;
    z-index:40;
    display:flex; align-items:flex-start; justify-content:center;
    padding-top: 62px;
    pointer-events:none;
  }
  .intro .stack{
    text-align:center;
    opacity:0;
    transform: translateY(8px);
    animation: introShow 5.2s ease forwards;
  }
  .intro h1{
    margin:0;
    font-size: clamp(22px, 3.5vw, 42px);
    text-shadow: 0 10px 25px rgba(0,0,0,0.25);
  }
  .intro p{
    margin:10px 0 0;
    font-size: clamp(13px, 2.0vw, 18px);
    opacity:0.92;
    text-shadow: 0 10px 25px rgba(0,0,0,0.20);
  }
  @keyframes introShow{
    0%   { opacity:0; transform: translateY(10px); }
    18%  { opacity:1; transform: translateY(0); }
    75%  { opacity:1; }
    100% { opacity:0; transform: translateY(-6px); }
  }

  /* ====== SURFACE LAYER ====== */
  .surface-layer{
    position:fixed;
    left:0; right:0;
    top: 11vh;
    height: 22vh;
    z-index:35;
    pointer-events:none;
  }

  /* Lotus pad improved (no skateboard look) */
  .pad{
    position:absolute;
    width: 210px;
    height: 90px;
    border-radius: 999px;
    background:
      radial-gradient(120px 60px at 35% 35%, rgba(255,255,255,0.20), transparent 60%),
      radial-gradient(140px 70px at 60% 55%, rgba(0,0,0,0.10), transparent 70%),
      linear-gradient(to bottom, rgba(110,255,190,0.95), rgba(24,150,110,0.96));
    border: 1px solid rgba(255,255,255,0.20);
    box-shadow:
      inset 0 10px 22px rgba(255,255,255,0.10),
      inset 0 -14px 22px rgba(0,0,0,0.12),
      0 20px 44px rgba(0,0,0,0.22);
    transform-origin:center;
    animation: padBob 4.6s ease-in-out infinite;
  }

  /* veins */
  .pad::before{
    content:"";
    position:absolute; inset:10px 18px;
    border-radius: 999px;
    background:
      radial-gradient(120px 50px at 45% 50%, rgba(255,255,255,0.08), transparent 60%),
      repeating-linear-gradient(35deg, rgba(255,255,255,0.07), rgba(255,255,255,0.07) 2px, transparent 2px, transparent 18px);
    opacity:0.55;
    mix-blend-mode: overlay;
  }

  /* notch cut */
  .pad::after{
    content:"";
    position:absolute;
    right: 18px;
    top: 34px;
    width: 42px;
    height: 34px;
    border-radius: 100px;
    box-shadow: inset -24px 0 0 rgba(0,0,0,0.14);
    transform: rotate(10deg);
    opacity:0.75;
  }

  @keyframes padBob{
    0%,100%{ transform: translateY(0) rotate(-0.5deg); }
    50%    { transform: translateY(4px) rotate(0.5deg); }
  }

  /* Frog improved (eyes not popping out) */
  .frog{
    position:absolute;
    width: 78px; height: 52px;
    left: 50%; top: 16px;
    transform: translateX(-50%);
    background: linear-gradient(to bottom, #bdf7c9, #22c55e);
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.20);
    box-shadow: 0 14px 28px rgba(0,0,0,0.16);
  }

  /* eye bumps INSIDE head (not outside) */
  .frog::before, .frog::after{
    content:"";
    position:absolute;
    width:18px; height:18px;
    top: 2px;                 /* FIX: no negative top */
    background: rgba(234,255,242,0.95);
    border-radius:50%;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,0.10);
  }
  .frog::before{ left: 14px; }
  .frog::after { right: 14px; }

  .frog .pupil{
    position:absolute;
    width:7px; height:7px;
    background: rgba(0,0,0,0.58);
    border-radius:50%;
    top: 7px;                 /* inside bump */
  }
  .frog .pupil.l{ left: 19px; }
  .frog .pupil.r{ right: 19px; }

  .frog-turn{ animation: frogTurn 2.1s ease-in-out infinite; transform-origin:center; }
  @keyframes frogTurn{
    0%,100%{ transform: translateX(-50%) rotate(0deg); }
    35%    { transform: translateX(-50%) rotate(4deg); }
    60%    { transform: translateX(-50%) rotate(-4deg); }
  }

  /* Lotus flower */
  .lotus{
    position:absolute;
    width: 78px; height: 62px;
    right: 18px; top: -10px;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,0.18));
    animation: lotusSway 4.4s ease-in-out infinite;
  }
  @keyframes lotusSway{
    0%,100%{ transform: rotate(-1deg) translateY(0); }
    50%{ transform: rotate(1deg) translateY(2px); }
  }
  .lotus .petal{
    position:absolute;
    left: 50%; top: 50%;
    width: 26px; height: 40px;
    background: radial-gradient(circle at 30% 30%, rgba(255,235,245,0.95), rgba(255,141,185,0.92));
    border-radius: 999px;
    transform-origin: bottom center;
    border: 1px solid rgba(255,255,255,0.18);
  }
  .lotus .petal:nth-child(1){ transform: translate(-50%,-58%) rotate(0deg); }
  .lotus .petal:nth-child(2){ transform: translate(-50%,-58%) rotate(45deg); }
  .lotus .petal:nth-child(3){ transform: translate(-50%,-58%) rotate(90deg); }
  .lotus .petal:nth-child(4){ transform: translate(-50%,-58%) rotate(135deg); }
  .lotus .petal:nth-child(5){ transform: translate(-50%,-58%) rotate(180deg); }
  .lotus .petal:nth-child(6){ transform: translate(-50%,-58%) rotate(225deg); }
  .lotus .petal:nth-child(7){ transform: translate(-50%,-58%) rotate(270deg); }
  .lotus .petal:nth-child(8){ transform: translate(-50%,-58%) rotate(315deg); }

  .lotus .center{
    position:absolute;
    left:50%; top:50%;
    width: 16px; height: 16px;
    background: radial-gradient(circle at 30% 30%, #fff5a5, #ffcc4a);
    border-radius:50%;
    transform: translate(-50%,-30%);
    border: 1px solid rgba(255,255,255,0.18);
  }

  /* ====== UI ====== */
  .ui-wrap{
    position:relative;
    z-index:20;
    padding: 270px 14px 40px;
    display:flex;
    justify-content:center;
  }
  .panel{
    width:min(980px, 100%);
    display:grid;
    grid-template-columns: 1.15fr 0.85fr;
    gap:16px;
    align-items:start;
  }
  .card{
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 16px;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
  }
  .upload-box{
    background: rgba(255,255,255,0.14);
    border: 1px solid rgba(255,255,255,0.18);
    padding: 16px;
    border-radius: 14px;
    cursor:pointer;
    transition: transform 0.15s ease, background 0.2s ease;
    font-weight:800;
  }
  .upload-box:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.18); }

  #prediction{ margin:12px 0 6px; font-size: 15px; }
  .description{ font-size: 13px; line-height: 1.55; opacity:0.95; }
  .description h3{ margin: 10px 0 6px; font-size: 13px; }
  .description ul{ margin: 0 0 0 18px; padding:0; }

  .carousel{ margin-top:10px; position:relative; width:100%; max-width:220px; }
  .carousel img{ width:100%; border-radius:14px; display:none; border:1px solid rgba(255,255,255,0.20); }
  .carousel img.active{ display:block; }
  .carousel button{
    position:absolute; top:50%; transform:translateY(-50%);
    background: rgba(0,0,0,0.25);
    border:1px solid rgba(255,255,255,0.16);
    color:white;
    font-size:18px;
    padding:6px 10px;
    cursor:pointer;
    border-radius:10px;
  }
  .prev{ left:6px; } .next{ right:6px; }

  .stars span{
    font-size:28px; cursor:pointer; color:rgba(255,255,255,0.40);
    display:inline-block; transition: transform 0.2s ease, color 0.2s ease;
  }
  .stars span.filled{ color: #ffd35a; transform: scale(1.08); }
  .thank-message{ margin-top:10px; min-height:24px; font-size: 13px; opacity:0.95; }

  .btn{
    width:100%;
    margin-top:10px;
    padding: 11px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.18);
    cursor:pointer;
    font-weight:900;
    background: rgba(0,0,0,0.22);
    color: var(--text);
    backdrop-filter: blur(8px);
    transition: transform 0.15s ease, background 0.2s ease;
  }
  .btn:hover{ transform: translateY(-1px); background: rgba(0,0,0,0.28); }
  .btn.primary{ background: rgba(39,174,96,0.45); }
  .btn.primary:hover{ background: rgba(39,174,96,0.55); }
  .btn.blue{ background: rgba(41,128,185,0.45); }
  .btn.blue:hover{ background: rgba(41,128,185,0.55); }

  @media (max-width: 860px){
    .panel{ grid-template-columns: 1fr; }
    .ui-wrap{ padding-top: 240px; }
  }

  /* ====== SEAWEED ====== */
  .seaweed{
    position:fixed;
    bottom:-12px;
    width: 22px;
    height: 240px;
    border-radius: 18px 18px 10px 10px;
    background: linear-gradient(to top, rgba(6,92,73,0.95), rgba(35,170,125,0.85));
    opacity:0.92;
    z-index:5;
    transform-origin: bottom center;
    animation: weedSway 3.7s ease-in-out infinite alternate;
  }
  @keyframes weedSway{
    from{ transform: rotate(-4deg); }
    to  { transform: rotate(4deg); }
  }

  /* ====== FISH ====== */
  .fish{
    position:fixed;
    width:62px; height:30px;
    z-index:18;                 /* FIX: visible but still behind UI(20) */
    pointer-events:none;
    will-change: transform;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,0.18));
  }
  .fish .body{
    position:absolute; inset:0;
    border-radius: 999px;
    background: var(--c);
    box-shadow: inset 0 3px 0 rgba(255,255,255,0.22);
  }
  .fish .tail{
    position:absolute; top:7px;
    width:18px; height:16px;
    background: var(--c);
    border-radius: 4px;
    clip-path: polygon(0 50%, 100% 0, 100% 100%);
    opacity:0.95;
  }
  .fish .finTop{
    position:absolute;
    width:16px; height:12px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 14px 14px 4px 4px;
    top: -3px;
    left: 22px;
    transform: rotate(-10deg);
  }
  .fish .finSide{
    position:absolute;
    width:14px; height:10px;
    background: rgba(255,255,255,0.14);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 10px 10px 10px 0;
    top: 10px;
    left: 24px;
    transform: rotate(-8deg);
  }
  .fish .eye{
    position:absolute; top:11px;
    width:7px; height:7px; border-radius:50%;
    background: rgba(0,0,0,0.55);
    box-shadow: 0 0 0 2px rgba(255,255,255,0.28);
  }

  /* FIX: right + left fish parts */
  .fish.right .tail{ left:-10px; }
  .fish.right .eye{ right:12px; }

  .fish.left  .tail{ right:-10px; transform: scaleX(-1); }
  .fish.left  .eye{ left:12px; }

  /* ====== BUBBLES ====== */
  .bubble{
    position:fixed;
    width: 10px; height: 10px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.90), rgba(255,255,255,0.10));
    box-shadow: 0 0 14px rgba(255,255,255,0.22);
    z-index:12;
    pointer-events:auto;
    will-change: transform;
    opacity:0.85;
  }
  .bubble.pop{ animation: pop 0.25s ease forwards !important; }
  @keyframes pop{ to{ transform: scale(2.0); opacity:0; } }

  .touch-ripple{
    position:fixed;
    width: 18px; height: 18px;
    border: 2px solid rgba(255,255,255,0.32);
    border-radius: 50%;
    pointer-events:none;
    z-index:14;
    transform: translate(-50%, -50%) scale(0.7);
    opacity: 0.75;
    animation: ripple 0.9s ease-out forwards;
  }
  @keyframes ripple{
    to{ transform: translate(-50%, -50%) scale(2.8); opacity:0; }
  }
</style>
</head>

<body>
  <div class="pond-bg">
    <div class="surface-band"></div>
    <div class="surface-wave"></div>
  </div>

  <div class="topbar">
    <div class="pill">üåø UniqueSeeker‚Äôs Algae Pond ‚Ä¢ Pond 2</div>
    <div class="right-pills">
      <div class="pill"><a href="./index.html">Pond 1</a></div>
      <div class="pill"><button id="pond2Btn">Pond 2</button></div>
    </div>
  </div>

  <div class="intro">
    <div class="stack">
      <h1>Welcome to Uniqueseeker‚Äôs Algal Pond</h1>
      <p>See if your algae is already here. Or help the journal grow.</p>
    </div>
  </div>

  <div class="surface-layer" id="surfaceLayer"></div>

  <div class="ui-wrap">
    <div class="panel">
      <div class="card">
        <div class="upload-box" id="uploadBox">üåø Select your algae photo to start!</div>
        <input type="file" id="imageUpload" accept="image/*" style="display:none;">
        <div id="prediction"></div>
        <div class="carousel" id="carousel"></div>
        <div id="description" class="description"></div>
      </div>

      <div class="card" style="text-align:center;">
        <div class="stars" id="stars"></div>
        <div class="thank-message" id="thankMessage"></div>
        <button class="btn primary contribute">Contribute üì®</button>
        <button class="btn blue explore">Explore Algae Around the World üåè</button>
      </div>
    </div>
  </div>

<script>
/* ===================== MODEL ===================== */
let model;
let classes = [];
const CONFIDENCE_THRESHOLD = 0.65;

const algaeInfo = {
  "spirogyra": {images:["images/spirogyra1.jpg","images/spirogyra2.jpg"], habit:["Filamentous freshwater green algae","Forms floating slimy masses","Has spiral chloroplasts"], economic:["Produces oxygen in ponds","Used in biological research"], location:["Found in freshwater ponds","Common in slow-moving water bodies"]},
  "cladophora": {images:["images/cladophora1.jpg","images/cladophora2.jpg","images/cladophora3.jpg"], habit:["Branched filamentous green algae","Attaches to submerged surfaces","Forms dense green mats"], economic:["Provides shelter for aquatic organisms","Indicates nutrient pollution levels"], location:["Freshwater & marine habitats","Common in nutrient-rich environments"]},
  "oedogonium": {images:["images/oedogonium1.jpg","images/oedogonium2.jpg"], habit:["Filamentous green algae with basal holdfast","Grows in mats or attached filaments","Prefers calm water"], economic:["Used in research and water quality monitoring","Oxygen producer in water bodies"], location:["Freshwater ponds and slow streams","Common in nutrient-rich ponds"]},
  "volvox": {images:["images/volvox1.jpg","images/volvox2.jpg"], habit:["Spherical colonial green algae","Colonies with flagella","Forms motile spheres"], economic:["Used in biological experiments","Oxygen producer"], location:["Freshwater ponds and lakes","Common in nutrient-rich water"]},
  "nostoc": {images:["images/nostoc1.jpg","images/nostoc2.jpg"], habit:["Cyanobacteria forming colonies","Gelatinous colonies","Filamentous structure"], economic:["Nitrogen fixation","Used in research"], location:["Freshwater and moist soils","Found on rocks and soil surfaces"]},
  "pediastrum": {images:["images/pediastrum1.jpg","images/pediastrum2.jpg"], habit:["Colonial green algae","Flat star-like colonies","Planktonic in water"], economic:["Used in ecological studies","Indicator of water quality"], location:["Freshwater ponds","Common in nutrient-rich water"]},
  "cosmarium": {images:["images/cosmarium1.jpg","images/cosmarium2.jpg"], habit:["Single-celled green algae with semicells","Desmids are symmetrical","Often found in colonies"], economic:["Used in ecological studies","Indicator of water quality"], location:["Freshwater habitats","Ponds and lakes with clean water"]},
  "noctiluca": {images:["images/noctiluca1.jpg","images/noctiluca2.jpg"], habit:["Bioluminescent marine plankton","Single-celled","Motile with flagella"], economic:["Indicators of marine water health","Can cause red tides"], location:["Marine environments","Coastal waters worldwide"]},
  "staurastrum": {images:["images/staurastrum1.jpg","images/staurastrum2.jpg"], habit:["Single-celled desmid","Star-shaped cells","Free-floating"], economic:["Used in water quality studies","Indicator species"], location:["Freshwater ponds","Clean, slow-moving waters"]},
  "scenedesmus": {images:["images/scenedesmus1.jpg","images/scenedesmus2.jpg"], habit:["Colonial green algae","Forms four-cell colonies","Common planktonic algae"], economic:["Used in biofuel research","Indicator of water quality"], location:["Freshwater ponds","Often in nutrient-rich waters"]}
};

async function loadModel(){
  model = await tf.loadLayersModel("my_model/model.json");
  const metadata = await fetch("my_model/metadata.json").then(res=>res.json());
  classes = metadata.labels.map(l => l.trim().toLowerCase());
}
loadModel();

/* ===================== UI ===================== */
const uploadBox = document.getElementById("uploadBox");
const imageUpload = document.getElementById("imageUpload");
uploadBox.addEventListener("click", ()=> imageUpload.click());

const starsContainer = document.getElementById("stars");
const thankMessage = document.getElementById("thankMessage");
let rating = 0;

function renderStars(){
  starsContainer.innerHTML="";
  for(let i=1;i<=5;i++){
    const star=document.createElement("span");
    star.innerHTML = (i<=rating) ? "‚òÖ" : "‚òÜ";
    if(i<=rating) star.classList.add("filled");
    star.onclick=()=> rateStar(i);
    star.addEventListener("touchstart",()=> rateStar(i), {passive:true});
    starsContainer.appendChild(star);
  }
}
function rateStar(i){
  rating=i; renderStars();
  const messages={1:"üò¢ We'll improve! Thanks!",2:"üôÇ Thank you! We‚Äôll grow!",3:"üòä Nice! Thanks!",4:"üåü Awesome! You‚Äôre amazing!",5:"üòç WOW! You love our pond!"};
  thankMessage.innerText=messages[i];
}
renderStars();

function createCarousel(images){
  const carouselDiv=document.getElementById("carousel");
  carouselDiv.innerHTML="";
  if(!images || images.length===0) return;

  images.forEach((src,i)=>{
    const img=document.createElement("img");
    img.src=src;
    if(i===0) img.classList.add("active");
    carouselDiv.appendChild(img);
  });

  const prevBtn=document.createElement("button");
  prevBtn.className="prev"; prevBtn.innerHTML="&#10094;"; prevBtn.onclick=()=> moveSlide(-1);
  const nextBtn=document.createElement("button");
  nextBtn.className="next"; nextBtn.innerHTML="&#10095;"; nextBtn.onclick=()=> moveSlide(1);
  carouselDiv.appendChild(prevBtn);
  carouselDiv.appendChild(nextBtn);
  carouselDiv.currentIndex=0;
}
function moveSlide(dir){
  const carouselDiv=document.getElementById("carousel");
  const imgs=carouselDiv.querySelectorAll("img");
  if(!imgs.length) return;
  imgs[carouselDiv.currentIndex].classList.remove("active");
  carouselDiv.currentIndex=(carouselDiv.currentIndex+dir+imgs.length)%imgs.length;
  imgs[carouselDiv.currentIndex].classList.add("active");
}

imageUpload.addEventListener("change", async (event)=>{
  const file = event.target.files[0];
  if(!file) return;

  const img = new Image();
  img.src = URL.createObjectURL(file);

  img.onload = async ()=>{
    const tensor = tf.browser.fromPixels(img)
      .resizeNearestNeighbor([224,224])
      .toFloat().div(255.0).expandDims();

    const prediction = model.predict(tensor);
    const data = await prediction.data();
    const maxValue = Math.max(...data);
    const index = data.indexOf(maxValue);
    const predictedClass = classes[index];
    const confidence = (maxValue*100).toFixed(2);

    const predictionText=document.getElementById("prediction");
    const descriptionBox=document.getElementById("description");
    const info = algaeInfo[predictedClass] || algaeInfo[(predictedClass||"").toLowerCase()];

    if((predictedClass||"").toLowerCase() === "unknown algae"){
      predictionText.innerHTML = "Prediction: <b>Unknown Algae</b>";
      descriptionBox.innerHTML = "<h3>üêüüåø Not yet in the pond!</h3><p>If you know it, please contribute a photo üå±üíö</p>";
      createCarousel([]);
      tensor.dispose(); prediction.dispose();
      return;
    }

    if(maxValue >= CONFIDENCE_THRESHOLD && info){
      predictionText.innerHTML = `Prediction: <b>${predictedClass.charAt(0).toUpperCase()+predictedClass.slice(1)}</b><br>Confidence: ${confidence}%`;
      createCarousel(info.images);
      descriptionBox.innerHTML =
        "<h3>Habit</h3><ul>"+info.habit.map(x=>"<li>"+x+"</li>").join("")+"</ul>"+
        "<h3>Economic Importance</h3><ul>"+info.economic.map(x=>"<li>"+x+"</li>").join("")+"</ul>"+
        "<h3>Location</h3><ul>"+info.location.map(x=>"<li>"+x+"</li>").join("")+"</ul>";
    } else {
      predictionText.innerHTML = `Confidence: ${confidence}%`;
      createCarousel([]);
      descriptionBox.innerHTML="<h3>üêüüåø Not yet in the pond!</h3><p>Hmm‚Ä¶ this algae is not yet in our pond. If you know it, please contribute üå±üíö</p>";
    }

    tensor.dispose();
    prediction.dispose();
  };
});

document.querySelector(".contribute").addEventListener("click",()=>{
  const email="uniqueseeekers123@gmail.com";
  const subject=encodeURIComponent("Algae Contribution üåø");
  const body=encodeURIComponent("Hello! I want to contribute an algae image or info to your pond project.");
  if(window.innerWidth>768){
    alert(`üíö Thanks for contributing!\nSend images/info to: ${email}`);
  }else{
    window.location.href=`mailto:${email}?subject=${subject}&body=${body}`;
  }
});
document.querySelector(".explore").addEventListener("click",()=>{
  alert("üåé Global algae exploration coming soon!");
});

/* ===================== POND VISUALS ===================== */
const surfaceLayer = document.getElementById("surfaceLayer");

function buildSurface(){
  surfaceLayer.innerHTML = "";

  const pad1 = document.createElement("div");
  pad1.className = "pad";
  pad1.style.left = "7%";
  pad1.style.top  = "4.4vh";

  const frog = document.createElement("div");
  frog.className = "frog frog-turn";
  frog.innerHTML = `<div class="pupil l"></div><div class="pupil r"></div>`;
  pad1.appendChild(frog);
  surfaceLayer.appendChild(pad1);

  const pad2 = document.createElement("div");
  pad2.className = "pad";
  pad2.style.left = "60%";
  pad2.style.top  = "6.1vh";
  pad2.style.opacity = "0.97";

  const lotus = document.createElement("div");
  lotus.className = "lotus";
  lotus.innerHTML = `
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
    <div class="center"></div>
  `;
  pad2.appendChild(lotus);
  surfaceLayer.appendChild(pad2);
}
buildSurface();

function buildSeaweed(){
  document.querySelectorAll(".seaweed").forEach(n=>n.remove());
  const positions = [
    {x:"2%",  h:230, d:"0s"},
    {x:"6%",  h:280, d:"0.6s"},
    {x:"10%", h:250, d:"1.1s"},
    {x:"90%", h:260, d:"0.4s"},
    {x:"94%", h:300, d:"1.0s"},
    {x:"98%", h:240, d:"1.5s"}
  ];
  positions.forEach(p=>{
    const w = document.createElement("div");
    w.className="seaweed";
    w.style.left = p.x;
    w.style.height = p.h+"px";
    w.style.animationDelay = p.d;
    document.body.appendChild(w);
  });
}
buildSeaweed();

function makeFish(color, dir){
  const f = document.createElement("div");
  f.className = "fish " + dir;
  f.style.setProperty("--c", color);
  f.innerHTML = `<div class="body"></div><div class="tail"></div><div class="finTop"></div><div class="finSide"></div><div class="eye"></div>`;
  document.body.appendChild(f);
  return f;
}

const fishEls = [
  makeFish("#ffb74a","right"),
  makeFish("#ff6b6b","left"),
  makeFish("#ffd966","right"),
  makeFish("#7dd3fc","left")
];

function animate(now){
  const vh = window.innerHeight;
  const vw = window.innerWidth;

  const minY = Math.floor(vh * 0.62);
  const maxY = Math.floor(vh * 0.94);

  fishEls.forEach((f, i)=>{
    const speed = 0.045 + i*0.010;
    const baseY = minY + ((maxY-minY) * (0.12 + i*0.24));
    const bob = Math.sin(now/900 + i) * 6;

    const W = vw + 160;
    const offset = (now * speed) % W;

    if(f.classList.contains("right")){
      const x = -140 + offset;
      f.style.transform = `translate3d(${x}px, ${baseY + bob}px, 0)`;
    }else{
      const x = (vw + 140) - offset;
      f.style.transform = `translate3d(${x}px, ${baseY + bob}px, 0) scaleX(-1)`;
    }
  });

  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

/* bubbles */
const MAX_BUBBLES = 10;
function spawnBubble(){
  const b = document.createElement("div");
  b.className = "bubble";
  const size = 7 + Math.random()*10;
  b.style.width = size+"px";
  b.style.height = size+"px";
  b.style.left = (Math.random()*window.innerWidth) + "px";
  b.style.top = (window.innerHeight * (0.55 + Math.random()*0.45)) + "px";

  const duration = 7 + Math.random()*6;
  const drift = (Math.random()*60 - 30);
  const startY = parseFloat(b.style.top);
  const startX = parseFloat(b.style.left);
  const start = performance.now();

  function step(now){
    const p = (now - start) / (duration*1000);
    if(p >= 1){ b.remove(); return; }
    const y = startY - p * (window.innerHeight * 0.60);
    const x = startX + drift * Math.sin(p*3.14);
    b.style.transform = `translate3d(${x-startX}px, ${y-startY}px, 0)`;
    b.style.opacity = (1 - p) * 0.85;
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  b.addEventListener("click", ()=>{ b.classList.add("pop"); setTimeout(()=>b.remove(), 220); });
  b.addEventListener("touchstart", ()=>{ b.classList.add("pop"); setTimeout(()=>b.remove(), 220); }, {passive:true});
  document.body.appendChild(b);
}
function bubbleLoop(){
  const current = document.querySelectorAll(".bubble").length;
  if(current < MAX_BUBBLES){
    for(let i=0;i<(MAX_BUBBLES-current);i++) spawnBubble();
  }
  setTimeout(bubbleLoop, 1200);
}
bubbleLoop();

function isUnderwater(y){ return y > window.innerHeight * 0.55; }
function makeRipple(x,y){
  const r = document.createElement("div");
  r.className="touch-ripple";
  r.style.left = x+"px";
  r.style.top = y+"px";
  document.body.appendChild(r);
  setTimeout(()=>r.remove(), 900);
}
document.addEventListener("pointerdown",(e)=>{
  if(!isUnderwater(e.clientY)) return;
  if(e.target.closest(".card, button, input, .upload-box, .carousel, .pill")) return;
  makeRipple(e.clientX, e.clientY);
});

window.addEventListener("resize", ()=>{
  buildSeaweed();
});
</script>
</body>
</html>
