<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dive Transition</title>

<link rel="prefetch" href="pond2.html" as="document">

<style>
:root{
  --surfaceA:#5FC2A7;
  --surfaceB:#3CC19E;
  --underA:#2aa98d;
  --underB:#146f6a;
  --deep:#083b46;
}

html,body{
  margin:0;
  height:100%;
  background:var(--deep); /* ✅ match deep water */
  font-family:system-ui, Arial;
}

body{
  overflow-x:hidden;
}

.track{
  position:relative;
  height:420vh;
  background:var(--deep); /* ✅ match deep water */
}

.camera{
  position:sticky;
  top:0;
  height:100vh;
  overflow:hidden;
  background:var(--deep); /* ✅ match deep water */
}

.bg{
  position:absolute;
  inset:-12%;
  background:
    radial-gradient(1200px 800px at 50% -10%, rgba(255,255,255,0.22), transparent 55%),
    linear-gradient(180deg,
      var(--surfaceA) 0%,
      var(--surfaceB) 28%,
      var(--underA) 55%,
      var(--underB) 78%,
      var(--deep) 100%);
  transform:translateY(var(--bgShift,0px)) scale(1.08);
  filter:saturate(1.12) brightness(var(--bri,1));
  will-change:transform,filter;
}

.surfaceLine{
  position:absolute;
  left:-10%; right:-10%;
  top:42%;
  height:14px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.9),transparent);
  opacity:var(--lineOp,0.95);
  transform:translateY(var(--lineY,0px));
  filter:blur(1px);
}

.caustics{
  position:absolute;
  inset:-30%;
  background:
    repeating-radial-gradient(circle at 20% 30%, rgba(255,255,255,0.08) 0 6px, transparent 6px 20px),
    repeating-radial-gradient(circle at 70% 60%, rgba(255,255,255,0.06) 0 7px, transparent 7px 22px);
  mix-blend-mode:overlay;
  opacity:var(--cOp,0);
  transform:translateY(var(--cY,0px)) rotate(-3deg) scale(1.08);
  filter:blur(1px);
  pointer-events:none;
}

.vignette{
  position:absolute;
  inset:0;
  background:radial-gradient(closest-side at 50% 40%,transparent 52%,rgba(0,0,0,0.46) 100%);
  opacity:0.78;
  pointer-events:none;
}

.bubbles{
  position:absolute;
  inset:0;
  pointer-events:none;
  overflow:hidden;
}

.bubble{
  position:absolute;
  bottom:-20vh;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%,
    rgba(255,255,255,0.95),
    rgba(255,255,255,0.18) 55%,
    rgba(255,255,255,0.07) 100%);
  filter:blur(var(--blur));
  opacity:0;
  animation:bubbleUp var(--dur) linear infinite;
  animation-delay:var(--delay);
}

@keyframes bubbleUp{
  0%{opacity:0;transform:translate3d(0,0,0) scale(var(--s));}
  10%{opacity:var(--op);}
  100%{opacity:0;transform:translate3d(var(--drift),-170vh,0) scale(calc(var(--s)*1.18));}
}

/* Fade out before redirect */
.fadeOut{
  position:fixed;
  inset:0;
  background:#062a33;
  opacity:0;
  pointer-events:none;
  transition:opacity 400ms ease;
}
.fadeOut.show{ opacity:1; }
</style>
</head>
<body>

<div class="track" id="track">
  <div class="camera">
    <div class="bg" id="bg"></div>
    <div class="caustics" id="caustics"></div>
    <div class="surfaceLine" id="surfaceLine"></div>
    <div class="bubbles" id="bubbles"></div>
    <div class="vignette"></div>
  </div>
</div>

<div class="fadeOut" id="fade"></div>

<script>
const NEXT_PAGE = "pond2.html";
const DURATION = 2400;
const FALL_SCREENS = 3.6;

// Pre-warm Pond2 (helps reduce lag)
fetch(NEXT_PAGE, { cache:"force-cache" }).catch(()=>{});

const track = document.getElementById("track");
const bg = document.getElementById("bg");
const caustics = document.getElementById("caustics");
const surfaceLine = document.getElementById("surfaceLine");
const bubblesWrap = document.getElementById("bubbles");
const fade = document.getElementById("fade");

const rnd=(a,b)=>a+Math.random()*(b-a);

// bubbles
for(let i=0;i<60;i++){
  const b=document.createElement("div");
  b.className="bubble";
  const big=Math.random()<0.4;
  const size=big?rnd(28,78):rnd(10,28);
  b.style.width=size+"px";
  b.style.height=size+"px";
  b.style.left=rnd(-10,110)+"vw";
  b.style.setProperty("--dur",(big?rnd(1.0,1.7):rnd(1.4,2.4))+"s");
  b.style.setProperty("--delay",rnd(0,1.2)+"s");
  b.style.setProperty("--drift",(big?rnd(-70,70):rnd(-38,38))+"px");
  b.style.setProperty("--s",(big?rnd(1.0,2.0):rnd(0.75,1.25)));
  b.style.setProperty("--op",(big?rnd(0.65,0.92):rnd(0.35,0.65)));
  b.style.setProperty("--blur",(big?rnd(0.6,2.2):rnd(0.2,1.0))+"px");
  bubblesWrap.appendChild(b);
}

function easeInOut(t){
  return t<0.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
}

// IMPORTANT: never reach the sticky release point
function computeSafeTarget(){
  const viewport = window.innerHeight;
  const trackHeight = track.getBoundingClientRect().height;

  // Sticky releases at (trackHeight - viewport). Stay well above that.
  const SAFE_BEFORE_RELEASE = Math.max(900, Math.round(viewport * 0.9)); // adaptive
  const safeMax = Math.max(0, (trackHeight - viewport) - SAFE_BEFORE_RELEASE);

  return Math.min(safeMax, viewport * FALL_SCREENS);
}

window.scrollTo(0,0);
let target = computeSafeTarget();
const t0 = performance.now();

function tick(now){
  const t=Math.min(1,(now-t0)/DURATION);
  const e=easeInOut(t);
  const y=target*e;
  window.scrollTo(0,y);

  bg.style.setProperty("--bgShift",(-e*180)+"px");
  bg.style.setProperty("--bri",(1-e*0.12).toFixed(3));
  surfaceLine.style.setProperty("--lineY",(-e*380)+"px");
  surfaceLine.style.setProperty("--lineOp",(1-e*1.15).toFixed(3));
  caustics.style.setProperty("--cOp",(e<0.65?(e/0.65)*0.38:0.22).toFixed(3));
  caustics.style.setProperty("--cY",(e*70)+"px");

  if(t<1){
    requestAnimationFrame(tick);
  }else{
    fade.classList.add("show");
    setTimeout(()=>window.location.href=NEXT_PAGE,400);
  }
}

// Recompute if desktop viewport changes (resize / zoom)
window.addEventListener("resize", ()=>{
  target = computeSafeTarget();
});

requestAnimationFrame(tick);
</script>

</body>
</html>
